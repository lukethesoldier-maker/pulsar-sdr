<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pulsar SDR Platform</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#05050a;--surface:#0b0b12;--card:#101018;--card2:#141420;
  --border:#1a1a2a;--border2:#252535;
  --orange:#ff6535;--pink:#e8369b;--purple:#8b5cf6;--blue:#38b6ff;--green:#00e676;
  --red:#ff4757;--yellow:#ffd32a;
  --white:#eeeef8;--muted:#55556a;--muted2:#8888a8;
  --r:12px;--rs:8px;
  --grad:linear-gradient(135deg,var(--orange),var(--pink));
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--white);font-family:'Sora',sans-serif;min-height:100vh;overflow-x:hidden;}
.aurora{position:fixed;inset:0;pointer-events:none;z-index:0;overflow:hidden;}
.ab{position:absolute;border-radius:50%;filter:blur(100px);animation:af 18s ease-in-out infinite alternate;}
.ab1{width:500px;height:500px;background:radial-gradient(circle,rgba(255,101,53,.09),transparent 70%);top:-150px;left:-100px;}
.ab2{width:400px;height:400px;background:radial-gradient(circle,rgba(232,54,155,.07),transparent 70%);top:30%;right:-100px;animation-delay:-6s;}
.ab3{width:600px;height:600px;background:radial-gradient(circle,rgba(56,182,255,.06),transparent 70%);bottom:-200px;left:30%;animation-delay:-12s;}
@keyframes af{0%{transform:translate(0,0)scale(1);}50%{transform:translate(25px,-20px)scale(1.07);}100%{transform:translate(-15px,25px)scale(.95);}}
.screen{display:none;position:relative;z-index:1;min-height:100vh;}
.screen.active{display:flex;}

/* ‚ïê‚ïê LOGIN ‚ïê‚ïê */
#screen-login{align-items:center;justify-content:center;padding:20px;}
.login-box{width:100%;max-width:400px;background:var(--card);border:1px solid var(--border2);border-radius:20px;padding:36px;animation:popIn .5s cubic-bezier(.34,1.56,.64,1);}
@keyframes popIn{from{opacity:0;transform:translateY(30px)scale(.96);}to{opacity:1;transform:none;}}
.login-logo{text-align:center;margin-bottom:28px;}
.ll-mark{font-family:'Bebas Neue';font-size:40px;letter-spacing:4px;background:linear-gradient(120deg,var(--orange),var(--pink) 45%,var(--purple) 75%,var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.ll-sub{font-size:11px;color:var(--muted2);letter-spacing:3px;text-transform:uppercase;margin-top:2px;}
.login-tabs{display:grid;grid-template-columns:1fr 1fr;gap:6px;background:var(--surface);border-radius:var(--rs);padding:4px;margin-bottom:24px;}
.ltab{padding:9px;text-align:center;border-radius:6px;font-size:13px;font-weight:600;cursor:pointer;color:var(--muted2);transition:all .2s;}
.ltab.active{background:var(--grad);color:white;}
.fi{width:100%;background:var(--surface);border:1px solid var(--border2);border-radius:var(--rs);padding:11px 14px;color:var(--white);font-family:'Sora',sans-serif;font-size:13px;outline:none;transition:border-color .2s;}
.fi:focus{border-color:rgba(255,101,53,.4);}
.fi::placeholder{color:var(--muted);}
.ff{margin-bottom:14px;}
.fl{font-size:11px;color:var(--muted2);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:6px;}
.btn{display:inline-flex;align-items:center;justify-content:center;gap:7px;padding:10px 20px;border-radius:var(--rs);font-family:'Sora',sans-serif;font-size:13px;font-weight:600;border:none;cursor:pointer;transition:all .2s;}
.btn-fire{background:var(--grad);color:white;box-shadow:0 4px 20px rgba(255,101,53,.25);}
.btn-fire:hover{transform:translateY(-1px);box-shadow:0 6px 28px rgba(255,101,53,.4);}
.btn-ghost{background:transparent;color:var(--muted2);border:1px solid var(--border2);}
.btn-ghost:hover{color:var(--white);border-color:var(--orange);}
.btn-sm{padding:7px 14px;font-size:12px;}
.btn-xs{padding:5px 10px;font-size:11px;}
.btn-green{background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.2);}
.btn-green:hover{background:rgba(0,230,118,.2);}
.btn-red{background:rgba(255,71,87,.12);color:var(--red);border:1px solid rgba(255,71,87,.2);}
.btn-red:hover{background:rgba(255,71,87,.25);}
.btn-yellow{background:rgba(255,211,42,.12);color:var(--yellow);border:1px solid rgba(255,211,42,.2);}
.btn-yellow:hover{background:rgba(255,211,42,.22);}
.login-err{font-size:12px;color:var(--red);text-align:center;margin-top:10px;display:none;}
.pw-wrap{position:relative;}
.pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;}

/* ‚ïê‚ïê AGENCY ‚ïê‚ïê */
#screen-agency{flex-direction:column;}
.agency-topbar{padding:14px 28px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(5,5,10,.95);backdrop-filter:blur(20px);position:sticky;top:0;z-index:50;}
.agency-logo{font-family:'Bebas Neue';font-size:22px;letter-spacing:3px;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.agency-badge{font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,101,53,.15);color:var(--orange);border:1px solid rgba(255,101,53,.25);letter-spacing:1px;margin-left:10px;}
.agency-content{padding:28px;flex:1;}
.master-stats{display:grid;grid-template-columns:repeat(5,1fr);gap:12px;margin-bottom:24px;}
.ms{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;position:relative;overflow:hidden;transition:border-color .3s,transform .2s;}
.ms:hover{border-color:var(--border2);transform:translateY(-2px);}
.ms::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--grad);opacity:0;transition:opacity .3s;}
.ms:hover::before{opacity:1;}
.ms-val{font-family:'Bebas Neue';font-size:34px;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.ms-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:4px;}
.ms-sub{font-size:11px;color:var(--green);margin-top:3px;}
.clients-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-bottom:24px;}
.client-card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:20px;transition:all .25s;}
.client-card:hover{border-color:rgba(255,101,53,.3);transform:translateY(-2px);box-shadow:0 8px 30px rgba(0,0,0,.3);}
.cc-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px;}
.cc-avatar{width:42px;height:42px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:19px;flex-shrink:0;}
.cc-info{flex:1;padding-left:11px;}
.cc-name{font-size:14px;font-weight:700;}
.cc-nicho{font-size:11px;color:var(--muted2);margin-top:2px;}
.cc-email{font-size:10px;color:var(--muted);margin-top:3px;}
.cc-metrics{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:12px;}
.ccm{background:var(--surface);border-radius:var(--rs);padding:8px;text-align:center;}
.ccm-val{font-size:17px;font-weight:700;color:var(--orange);}
.ccm-lbl{font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px;}
.cc-bar{height:3px;background:var(--border);border-radius:2px;margin-bottom:12px;}
.cc-bar-fill{height:100%;border-radius:2px;background:var(--grad);}
.cc-actions{display:flex;gap:6px;flex-wrap:wrap;}
.add-client-card{background:transparent;border:2px dashed var(--border2);border-radius:var(--r);padding:20px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;cursor:pointer;min-height:200px;transition:all .2s;color:var(--muted);}
.add-client-card:hover{border-color:var(--orange);color:var(--orange);}
.plan-badge{padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;letter-spacing:.5px;}
.plan-basico{background:rgba(56,182,255,.15);color:var(--blue);border:1px solid rgba(56,182,255,.25);}
.plan-pro{background:rgba(139,92,246,.2);color:#b09af8;border:1px solid rgba(139,92,246,.3);}
.plan-premium{background:rgba(255,101,53,.15);color:var(--orange);border:1px solid rgba(255,101,53,.25);}
.pill{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;}
.pill-active{background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.2);}
.pill-trial{background:rgba(255,211,42,.12);color:var(--yellow);border:1px solid rgba(255,211,42,.2);}
.pill-paused{background:rgba(85,85,106,.15);color:var(--muted2);border:1px solid var(--border2);}

/* ‚ïê‚ïê CLIENT PANEL ‚ïê‚ïê */
#screen-client{flex-direction:column;}
.sidebar{width:230px;background:rgba(10,10,18,.98);border-right:1px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;}
.sb-logo{padding:20px 18px 16px;border-bottom:1px solid var(--border);}
.sb-brand{font-family:'Bebas Neue';font-size:22px;letter-spacing:3px;background:linear-gradient(120deg,var(--orange),var(--pink) 45%,var(--purple) 75%,var(--blue));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;line-height:1;}
.sb-client{font-size:11px;color:var(--muted2);margin-top:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ai-live{display:inline-flex;align-items:center;gap:5px;font-size:9px;font-weight:700;padding:2px 8px;border-radius:20px;background:rgba(0,230,118,.1);color:var(--green);border:1px solid rgba(0,230,118,.2);margin-top:6px;letter-spacing:1px;}
.ai-paused{background:rgba(255,211,42,.1);color:var(--yellow);border:1px solid rgba(255,211,42,.2);}
.pring{width:6px;height:6px;border-radius:50%;background:var(--green);animation:dp 1.5s infinite;}
.pring-y{background:var(--yellow);}
@keyframes dp{0%,100%{opacity:1;}50%{opacity:.4;}}
.sb-nav{padding:10px 8px;flex:1;overflow-y:auto;}
.nb{display:flex;align-items:center;gap:9px;width:100%;padding:9px 10px;border-radius:var(--rs);background:none;border:none;color:var(--muted2);font-family:'Sora',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s;text-align:left;margin-bottom:1px;}
.nb:hover{color:var(--white);background:rgba(255,255,255,.04);}
.nb.active{color:var(--white);background:linear-gradient(90deg,rgba(255,101,53,.15),rgba(232,54,155,.08));border-left:2px solid var(--orange);}
.nb .ni{width:18px;font-size:14px;text-align:center;}
.npill{margin-left:auto;font-size:9px;font-weight:700;padding:2px 6px;border-radius:20px;background:var(--orange);color:#000;}
.sb-foot{padding:14px 18px;border-top:1px solid var(--border);}
.main-panel{margin-left:230px;display:flex;flex-direction:column;min-height:100vh;}
.topbar{padding:13px 26px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:rgba(5,5,10,.95);backdrop-filter:blur(20px);position:sticky;top:0;z-index:50;}
.topbar-title{font-size:16px;font-weight:600;}
.topbar-right{display:flex;gap:8px;align-items:center;}
.content{padding:26px;flex:1;}
.view{display:none;}
.view.active{display:block;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.stat{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;transition:border-color .3s,transform .2s;}
.stat:hover{border-color:var(--border2);transform:translateY(-2px);}
.stat-lbl{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;}
.stat-num{font-family:'Bebas Neue';font-size:36px;line-height:1;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.stat-sub{font-size:11px;color:var(--green);margin-top:4px;}

/* PANEL */
.panel{background:var(--card);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.ph{padding:13px 18px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;}
.ph-t{font-size:14px;font-weight:600;display:flex;align-items:center;gap:7px;}

/* ‚ïê‚ïê INBOX / CONVERSAS ‚ïê‚ïê */
.inbox-wrap{display:grid;grid-template-columns:300px 1fr;gap:0;height:600px;border:1px solid var(--border);border-radius:var(--r);overflow:hidden;}
.contact-list{border-right:1px solid var(--border);display:flex;flex-direction:column;background:var(--surface);}
.contact-search{padding:12px;border-bottom:1px solid var(--border);}
.contact-search input{width:100%;background:var(--card);border:1px solid var(--border2);border-radius:var(--rs);padding:8px 12px;color:var(--white);font-family:'Sora',sans-serif;font-size:12px;outline:none;}
.contact-search input:focus{border-color:rgba(255,101,53,.4);}
.contact-items{flex:1;overflow-y:auto;}
.contact-item{padding:12px 14px;border-bottom:1px solid rgba(26,26,42,.6);cursor:pointer;transition:background .15s;display:flex;align-items:flex-start;gap:10px;}
.contact-item:hover{background:rgba(255,255,255,.025);}
.contact-item.active{background:rgba(255,101,53,.08);border-left:2px solid var(--orange);}
.contact-item.unread .ci-name{color:var(--white);font-weight:700;}
.ci-ava{width:36px;height:36px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:15px;background:var(--card2);border:1px solid var(--border2);}
.ci-body{flex:1;min-width:0;}
.ci-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:2px;}
.ci-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ci-time{font-size:10px;color:var(--muted);flex-shrink:0;}
.ci-preview{font-size:11px;color:var(--muted2);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.ci-badge{display:inline-block;background:var(--orange);color:#000;font-size:9px;font-weight:800;min-width:16px;height:16px;border-radius:8px;text-align:center;line-height:16px;padding:0 4px;flex-shrink:0;}
.ci-score{display:inline-flex;align-items:center;gap:3px;font-size:9px;font-weight:700;padding:1px 5px;border-radius:8px;margin-top:3px;}
.cs-hot{background:rgba(255,71,87,.12);color:#f87171;}
.cs-warm{background:rgba(255,101,53,.12);color:var(--orange);}
.cs-cold{background:rgba(56,182,255,.12);color:var(--blue);}

/* CHAT PANEL */
.chat-main{display:flex;flex-direction:column;background:var(--bg);}
.chat-header{padding:12px 18px;border-bottom:1px solid var(--border);background:var(--card);display:flex;align-items:center;gap:12px;}
.chat-header-ava{width:34px;height:34px;border-radius:50%;background:var(--card2);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:14px;}
.chat-header-info{flex:1;}
.chat-header-name{font-size:14px;font-weight:700;}
.chat-header-sub{font-size:11px;color:var(--muted2);}
.chat-header-actions{display:flex;gap:6px;}
.chat-win{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:10px;scrollbar-width:thin;scrollbar-color:var(--border) transparent;}
.bubble-row{display:flex;gap:9px;animation:su .3s ease;}
@keyframes su{from{opacity:0;transform:translateY(8px);}to{opacity:1;transform:none;}}
.bubble-row.lr{flex-direction:row-reverse;}
.av{width:28px;height:28px;border-radius:50%;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:11px;}
.av.ai{background:var(--grad);font-family:'Bebas Neue';font-size:9px;color:white;}
.av.lead{background:var(--card2);border:1px solid var(--border2);font-size:13px;}
.bdy{max-width:78%;}
.bsender{font-size:9px;color:var(--muted);margin-bottom:2px;}
.lr .bsender{text-align:right;}
.bubble{padding:8px 12px;border-radius:12px;font-size:13px;line-height:1.6;}
.ai-bub{background:linear-gradient(135deg,rgba(255,101,53,.1),rgba(232,54,155,.07));border:1px solid rgba(255,101,53,.18);border-radius:3px 12px 12px 12px;}
.lead-bub{background:var(--card2);border:1px solid var(--border2);border-radius:12px 3px 12px 12px;color:#c0c0d8;}
.sys-bub{background:rgba(56,182,255,.06);border:1px solid rgba(56,182,255,.12);border-radius:8px;padding:6px 12px;font-size:11px;color:var(--blue);text-align:center;align-self:center;margin:4px 0;}
.btime{font-size:9px;color:var(--muted);margin-top:2px;}
.lr .btime{text-align:right;}
.sbadge{display:inline-flex;align-items:center;gap:4px;font-size:9px;font-weight:700;padding:2px 7px;border-radius:20px;margin-top:4px;text-transform:uppercase;}
.s0{background:rgba(139,92,246,.15);color:#b09af8;border:1px solid rgba(139,92,246,.25);}
.s1{background:rgba(56,182,255,.15);color:var(--blue);border:1px solid rgba(56,182,255,.25);}
.s2{background:rgba(255,101,53,.15);color:var(--orange);border:1px solid rgba(255,101,53,.25);}
.s3{background:rgba(0,212,255,.15);color:#00d4ff;border:1px solid rgba(0,212,255,.25);}
.s4{background:rgba(232,54,155,.2);color:var(--pink);border:1px solid rgba(232,54,155,.3);}
.typing-row{display:flex;gap:9px;}
.tbub{padding:10px 13px;background:rgba(255,101,53,.07);border:1px solid rgba(255,101,53,.15);border-radius:3px 12px 12px 12px;display:flex;gap:4px;align-items:center;}
.td{width:5px;height:5px;border-radius:50%;background:var(--orange);animation:td 1.3s ease-in-out infinite;}
.td:nth-child(2){animation-delay:.2s;}.td:nth-child(3){animation-delay:.4s;}
@keyframes td{0%,60%,100%{transform:translateY(0);opacity:.4;}30%{transform:translateY(-4px);opacity:1;}}
.chat-bar{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:9px;align-items:flex-end;background:var(--card);}
.chat-in{flex:1;background:var(--surface);border:1px solid var(--border2);border-radius:var(--rs);padding:9px 13px;color:var(--white);font-family:'Sora',sans-serif;font-size:13px;resize:none;outline:none;max-height:100px;transition:border-color .2s;}
.chat-in:focus{border-color:rgba(255,101,53,.4);}
.chat-in::placeholder{color:var(--muted);}
.send-b{width:38px;height:38px;border-radius:var(--rs);border:none;background:var(--grad);color:white;font-size:15px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.send-b:hover:not(:disabled){transform:scale(1.06);}
.send-b:disabled{opacity:.4;cursor:not-allowed;}

/* LEAD INFO SIDE */
.lead-side{width:260px;border-left:1px solid var(--border);background:var(--surface);display:flex;flex-direction:column;overflow-y:auto;}
.lead-info{padding:16px;}
.lead-ava{width:46px;height:46px;border-radius:50%;background:linear-gradient(135deg,var(--purple),var(--blue));display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 0 16px rgba(139,92,246,.3);margin-bottom:11px;}
.lead-name{font-size:16px;font-weight:700;}
.lead-sub{font-size:11px;color:var(--muted2);margin-top:2px;margin-bottom:12px;}
.score-row{display:flex;justify-content:space-between;font-size:11px;margin-bottom:5px;}
.score-track{height:5px;background:var(--border);border-radius:3px;}
.score-fill{height:100%;border-radius:3px;background:var(--grad);box-shadow:0 0 8px rgba(255,101,53,.3);transition:width 1s cubic-bezier(.34,1.56,.64,1);}
.tags{display:flex;flex-wrap:wrap;gap:5px;margin:10px 0 12px;}
.tag{font-size:10px;padding:3px 8px;border-radius:20px;border:1px solid var(--border2);color:var(--muted2);}
.ac-row{display:grid;grid-template-columns:1fr 1fr;gap:7px;margin-top:10px;}
.jtrack{padding:10px 14px;display:flex;flex-direction:column;gap:4px;}
.jstep{display:flex;align-items:center;gap:9px;padding:5px 0;}
.jdot{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:10px;flex-shrink:0;transition:all .3s;}
.jdot.done{background:rgba(0,230,118,.15);border:1px solid rgba(0,230,118,.3);color:var(--green);}
.jdot.now{background:var(--grad);}
.jdot.todo{background:var(--surface);border:1px solid var(--border2);color:var(--muted);}
.ji-l{font-size:11px;font-weight:600;}

/* TABLE */
table{width:100%;border-collapse:collapse;}
th{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;text-align:left;padding:9px 12px;border-bottom:1px solid var(--border);}
td{padding:10px 12px;border-bottom:1px solid rgba(26,26,42,.6);font-size:13px;vertical-align:middle;}
tr:hover td{background:rgba(255,101,53,.02);}
.tname{font-weight:600;}.tsub{font-size:10px;color:var(--muted);margin-top:1px;}
.temp{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-size:10px;font-weight:700;}
.t-hot{background:rgba(239,68,68,.12);color:#f87171;border:1px solid rgba(239,68,68,.25);}
.t-warm{background:rgba(255,101,53,.12);color:var(--orange);border:1px solid rgba(255,101,53,.25);}
.t-cold{background:rgba(56,182,255,.12);color:var(--blue);border:1px solid rgba(56,182,255,.25);}
.pmini{display:inline-block;width:48px;height:4px;background:var(--border);border-radius:2px;vertical-align:middle;}
.pfill{height:100%;border-radius:2px;background:var(--grad);}
.funnel-bar{display:flex;align-items:center;gap:12px;padding:9px 12px;background:var(--surface);border-radius:var(--rs);margin-bottom:6px;}
.fb-label{font-size:12px;font-weight:600;width:120px;flex-shrink:0;}
.fb-track{flex:1;height:6px;background:var(--border);border-radius:3px;}
.fb-fill{height:100%;border-radius:3px;background:var(--grad);}
.fb-count{font-family:'Bebas Neue';font-size:20px;color:var(--orange);width:40px;text-align:right;}
.train-form{padding:20px;display:flex;flex-direction:column;gap:16px;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
select.fi option{background:var(--card);}
textarea.fi{resize:vertical;min-height:80px;line-height:1.6;}

/* ZAPI CONFIG */
.zapi-status-bar{display:flex;align-items:center;gap:12px;padding:14px 18px;border-radius:var(--r);margin-bottom:20px;}
.zapi-on{background:linear-gradient(135deg,rgba(0,230,118,.08),rgba(0,230,118,.03));border:1px solid rgba(0,230,118,.2);}
.zapi-off{background:rgba(255,211,42,.05);border:1px solid rgba(255,211,42,.2);}
.zapi-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.zapi-dot-on{background:var(--green);box-shadow:0 0 8px rgba(0,230,118,.5);animation:dp 2s infinite;}
.zapi-dot-off{background:var(--yellow);}
.setup-step{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:15px 18px;display:flex;align-items:center;gap:14px;margin-bottom:10px;}
.snum{width:28px;height:28px;border-radius:50%;background:var(--grad);display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700;flex-shrink:0;color:white;}
.si{flex:1;}.si-t{font-size:13px;font-weight:600;}.si-d{font-size:11px;color:var(--muted);margin-top:2px;}

/* TOGGLE SWITCH */
.toggle-wrap{display:flex;align-items:center;gap:10px;}
.toggle{width:44px;height:24px;border-radius:12px;background:var(--border2);border:none;cursor:pointer;position:relative;transition:background .3s;flex-shrink:0;}
.toggle.on{background:var(--green);}
.toggle::after{content:'';position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:white;transition:transform .3s;box-shadow:0 1px 4px rgba(0,0,0,.3);}
.toggle.on::after{transform:translateX(20px);}
.toggle-label{font-size:13px;font-weight:600;}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(12px);z-index:300;display:none;align-items:center;justify-content:center;padding:20px;}
.modal-bg.open{display:flex;}
.modal{background:var(--card);border:1px solid var(--border2);border-radius:18px;width:100%;max-width:480px;padding:28px;animation:mIn .3s cubic-bezier(.34,1.56,.64,1);max-height:90vh;overflow-y:auto;}
@keyframes mIn{from{opacity:0;transform:scale(.92)translateY(20px);}to{opacity:1;transform:none;}}
.m-title{font-size:18px;font-weight:700;margin-bottom:5px;}
.m-desc{color:var(--muted);font-size:12px;margin-bottom:20px;line-height:1.6;}
.m-btns{display:flex;gap:9px;justify-content:flex-end;margin-top:20px;}
.confirm-bg{position:fixed;inset:0;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);z-index:350;display:none;align-items:center;justify-content:center;padding:20px;}
.confirm-bg.open{display:flex;}
.confirm-box{background:var(--card);border:1px solid rgba(255,71,87,.3);border-radius:16px;width:100%;max-width:360px;padding:24px;animation:mIn .3s ease;}
.toast{position:fixed;bottom:24px;right:24px;z-index:400;background:var(--card2);border:1px solid var(--border2);border-radius:var(--r);padding:12px 18px;display:flex;align-items:center;gap:9px;font-size:13px;box-shadow:0 8px 40px rgba(0,0,0,.5);transform:translateY(70px);opacity:0;transition:all .4s cubic-bezier(.34,1.56,.64,1);pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}

/* MISC */
.gt{background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.sec-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.sec-title{font-size:16px;font-weight:700;}
.info-row{display:flex;justify-content:space-between;padding:9px 12px;background:var(--surface);border-radius:var(--rs);font-size:12px;}
.info-row span:first-child{color:var(--muted);}
.info-row span:last-child{font-weight:600;}

@media(max-width:768px){
  .master-stats{grid-template-columns:repeat(2,1fr);}
  .stats-row{grid-template-columns:repeat(2,1fr);}
  .inbox-wrap{grid-template-columns:1fr;}
  .lead-side{display:none;}
  .sidebar{transform:translateX(-100%);transition:transform .3s;}
  .sidebar.mob-open{transform:translateX(0);}
  .main-panel{margin-left:0;}
}
::-webkit-scrollbar{width:3px;}::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
</style>
</head>
<body>
<div class="aurora"><div class="ab ab1"></div><div class="ab ab2"></div><div class="ab ab3"></div></div>

<!-- ‚ïê‚ïê LOGIN ‚ïê‚ïê -->
<div class="screen active" id="screen-login">
  <div class="login-box">
    <div class="login-logo">
      <div class="ll-mark">PULSAR</div>
      <div class="ll-sub">SDR AI Platform</div>
    </div>
    <div class="login-tabs">
      <div class="ltab active" onclick="setLoginTab('agency',this)">üè¢ Ag√™ncia</div>
      <div class="ltab" onclick="setLoginTab('client',this)">üè™ Cliente</div>
    </div>
    <div id="login-agency-form">
      <div class="ff"><label class="fl">E-mail da Ag√™ncia</label><input class="fi" type="email" id="ag-email" placeholder="agencia@pulsar.com" autocomplete="email"/></div>
      <div class="ff"><label class="fl">Senha</label><div class="pw-wrap"><input class="fi" type="password" id="ag-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/><button class="pw-toggle" type="button" onclick="togglePw('ag-pass',this)">üëÅ</button></div></div>
      <button class="btn btn-fire" style="width:100%;margin-top:4px;" onclick="loginAgency()">Entrar como Ag√™ncia ‚Üí</button>
      <div class="login-err" id="ag-err">E-mail ou senha incorretos.</div>
    </div>
    <div id="login-client-form" style="display:none;">
      <div class="ff"><label class="fl">E-mail</label><input class="fi" type="email" id="cl-email" placeholder="cliente@empresa.com" autocomplete="email"/></div>
      <div class="ff"><label class="fl">Senha</label><div class="pw-wrap"><input class="fi" type="password" id="cl-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"/><button class="pw-toggle" type="button" onclick="togglePw('cl-pass',this)">üëÅ</button></div></div>
      <button class="btn btn-fire" style="width:100%;margin-top:4px;" onclick="loginClient()">Entrar ‚Üí</button>
      <div class="login-err" id="cl-err">E-mail ou senha incorretos.</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê AGENCY ‚ïê‚ïê -->
<div class="screen" id="screen-agency" style="flex-direction:column;">
  <div class="agency-topbar">
    <div style="display:flex;align-items:center;">
      <div class="agency-logo">PULSAR SDR</div>
      <span class="agency-badge">AG√äNCIA MASTER</span>
    </div>
    <div style="display:flex;gap:9px;align-items:center;">
      <button class="btn btn-fire btn-sm" onclick="addClientModal()">+ Novo Cliente</button>
      <button class="btn btn-ghost btn-sm" onclick="logout()">Sair</button>
    </div>
  </div>
  <div class="agency-content">
    <div class="master-stats">
      <div class="ms"><div class="ms-val" id="stat-clientes">0</div><div class="ms-lbl">Clientes Ativos</div><div class="ms-sub" id="stat-clientes-sub">‚Äî</div></div>
      <div class="ms"><div class="ms-val" id="stat-leads">0</div><div class="ms-lbl">Leads Totais</div><div class="ms-sub">Gerados pelo agente</div></div>
      <div class="ms"><div class="ms-val" id="stat-hot">0</div><div class="ms-lbl">Leads Quentes</div><div class="ms-sub">Prontos p/ fechar</div></div>
      <div class="ms"><div class="ms-val" id="stat-mrr">R$0</div><div class="ms-lbl">MRR Mensalidades</div><div class="ms-sub">‚Üë Crescendo</div></div>
      <div class="ms"><div class="ms-val">94%</div><div class="ms-lbl">Engajamento IA</div><div class="ms-sub">24/7 dispon√≠vel</div></div>
    </div>
    <div class="sec-hdr">
      <div class="sec-title">üè™ Clientes</div>
      <button class="btn btn-fire btn-sm" onclick="addClientModal()">+ Adicionar Cliente</button>
    </div>
    <div class="clients-grid" id="clientsGrid"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:8px;">
      <div class="panel">
        <div class="ph"><div class="ph-t">üîë API Key Anthropic</div><span id="apiStatusBadge" style="font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,71,87,.12);color:var(--red);border:1px solid rgba(255,71,87,.2);">N√£o configurada</span></div>
        <div style="padding:18px;">
          <div style="font-size:12px;color:var(--muted2);line-height:1.6;margin-bottom:14px;background:rgba(56,182,255,.05);border:1px solid rgba(56,182,255,.1);border-radius:var(--rs);padding:11px;">üí° <strong style="color:var(--white);">Chave centralizada</strong> ‚Äî usada por todos os clientes. Eles nunca t√™m acesso.</div>
          <div class="ff"><label class="fl">Chave da API</label><div style="display:flex;gap:8px;"><input class="fi" type="password" id="agencyApiKey" placeholder="sk-ant-api03-..." style="flex:1;" oninput="checkApiKey(this.value)"/><button class="btn btn-ghost btn-sm" onclick="toggleApiKeyVisibility()">üëÅ</button></div></div>
          <div class="ff"><label class="fl">Modelo IA</label><select class="fi" id="agencyModel"><option value="claude-sonnet-4-20250514">claude-sonnet-4 ‚Äî Melhor qualidade ‚úÖ</option><option value="claude-haiku-4-5-20251001">claude-haiku-4-5 ‚Äî Mais econ√¥mico</option></select></div>
          <button class="btn btn-fire" style="width:100%;justify-content:center;" onclick="saveAgencyApiKey()">üîë Salvar e Ativar</button>
        </div>
      </div>
      <div class="panel">
        <div class="ph"><div class="ph-t">üìä Estimativa de Receita</div></div>
        <div style="padding:18px;display:flex;flex-direction:column;gap:8px;">
          <div class="info-row"><span>Clientes ativos</span><span id="activeClientsCount">0</span></div>
          <div class="info-row"><span>Custo IA estimado/m√™s</span><span style="color:var(--orange);" id="ia-cost">R$0</span></div>
          <div class="info-row"><span>Custo operacional (Zapi+Railway)</span><span style="color:var(--orange);">~R$150</span></div>
          <div class="info-row"><span>Mensalidades dos clientes</span><span style="color:var(--green);" id="mrrDisplay">R$0</span></div>
          <div style="display:flex;justify-content:space-between;padding:11px 12px;background:linear-gradient(90deg,rgba(0,230,118,.06),transparent);border:1px solid rgba(0,230,118,.1);border-radius:var(--rs);">
            <span style="font-size:12px;color:var(--green);">Margem l√≠quida estimada</span>
            <span style="font-weight:700;font-size:15px;color:var(--green);" id="margem-display">R$0</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê CLIENT PANEL ‚ïê‚ïê -->
<div class="screen" id="screen-client">
  <div class="sidebar" id="sidebar">
    <div class="sb-logo">
      <div class="sb-brand">PULSAR SDR</div>
      <div class="sb-client" id="sb-client-name">‚Äî</div>
      <div class="ai-live" id="ai-status-badge"><div class="pring" id="pring-dot"></div><span id="ai-status-text">IA ATIVA 24/7</span></div>
    </div>
    <div class="sb-nav">
      <button class="nb active" onclick="showView('dash',this)"><span class="ni">üìä</span>Dashboard</button>
      <button class="nb" onclick="showView('inbox',this)"><span class="ni">üí¨</span>Conversas<span class="npill" id="inbox-count">0</span></button>
      <button class="nb" onclick="showView('leads',this)"><span class="ni">üë•</span>Leads<span class="npill" id="leads-count">0</span></button>
      <button class="nb" onclick="showView('funil',this)"><span class="ni">üîª</span>Funil</button>
      <button class="nb" onclick="showView('treinamento',this)"><span class="ni">üß†</span>Treinamento</button>
      <button class="nb" onclick="showView('zapi',this)"><span class="ni">üì±</span>Zapi & Workflow</button>
      <button class="nb" onclick="showView('config',this)"><span class="ni">‚öôÔ∏è</span>Configura√ß√µes</button>
    </div>
    <div class="sb-foot">
      <div style="font-size:11px;color:var(--muted2);margin-bottom:8px;">Pulsar Marketing 360</div>
      <button class="btn btn-ghost btn-sm" style="width:100%" onclick="backToAgency()">‚Üê Voltar ao Painel</button>
    </div>
  </div>

  <div class="main-panel">
    <div class="topbar">
      <div class="topbar-title" id="pageTitle">Dashboard</div>
      <div class="topbar-right">
        <div class="toggle-wrap">
          <button class="toggle" id="agente-toggle" onclick="toggleAgente(this)"></button>
          <span class="toggle-label" id="agente-toggle-label" style="font-size:12px;color:var(--muted2);">Agente ativo</span>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="logout()">Sair</button>
      </div>
    </div>

    <div class="content">

      <!-- DASHBOARD -->
      <div class="view active" id="view-dash">
        <div class="stats-row">
          <div class="stat"><div class="stat-lbl">Conversas Hoje</div><div class="stat-num" id="d-conversas">0</div><div class="stat-sub">Via WhatsApp</div></div>
          <div class="stat"><div class="stat-lbl">Leads Quentes</div><div class="stat-num" id="d-hot">0</div><div class="stat-sub">Prontos p/ fechar</div></div>
          <div class="stat"><div class="stat-lbl">Fechamentos</div><div class="stat-num" id="d-conv">0</div><div class="stat-sub">Este m√™s</div></div>
          <div class="stat"><div class="stat-lbl">Taxa Engajamento</div><div class="stat-num" id="d-score">94%</div><div class="stat-sub">Respostas do agente</div></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="panel">
            <div class="ph"><div class="ph-t">üî• Leads Quentes</div><button class="btn btn-green btn-xs" onclick="exportHot()">üì± Enviar WA</button></div>
            <div style="overflow-x:auto;"><table><thead><tr><th>Lead</th><th>Temp</th><th>Score</th><th>A√ß√£o</th></tr></thead><tbody id="hotTbl"></tbody></table></div>
          </div>
          <div class="panel">
            <div class="ph"><div class="ph-t">üì± Status do Agente</div></div>
            <div style="padding:16px;display:flex;flex-direction:column;gap:10px;">
              <div id="dash-agent-status" style="display:flex;align-items:center;gap:10px;padding:12px;background:rgba(0,230,118,.06);border:1px solid rgba(0,230,118,.15);border-radius:var(--rs);">
                <div style="width:9px;height:9px;border-radius:50%;background:var(--green);animation:dp 2s infinite;"></div>
                <div><div style="font-size:13px;font-weight:700;color:var(--green);" id="dash-status-text">Agente Ativo ‚Äî Respondendo leads</div><div style="font-size:11px;color:var(--muted);margin-top:1px;">Zapi + n8n + Claude AI ¬∑ 24/7</div></div>
              </div>
              <div class="info-row"><span>√öltima resposta enviada</span><span style="color:var(--blue);" id="dash-last-resp">‚Äî</span></div>
              <div class="info-row"><span>Conversas ativas agora</span><span style="color:var(--orange);" id="dash-active-conv">0</span></div>
              <div class="info-row"><span>Tempo m√©dio de resposta</span><span style="color:var(--green);">~3s</span></div>
              <div class="info-row"><span>Workflow n8n</span><span id="dash-n8n-status" style="color:var(--green);">‚óè Ativo</span></div>
            </div>
          </div>
        </div>
      </div>

      <!-- INBOX / CONVERSAS -->
      <div class="view" id="view-inbox">
        <div class="sec-hdr">
          <div><div class="sec-title">üí¨ Conversas ‚Äî Inbox WhatsApp</div><div style="font-size:11px;color:var(--muted);margin-top:2px;">Todas as conversas do seu agente SDR em tempo real</div></div>
          <div style="display:flex;gap:8px;">
            <button class="btn btn-fire btn-sm" id="btn-load-zapi" onclick="fetchZapiChats()">üì≤ Sincronizar WhatsApp</button>
            <button class="btn btn-ghost btn-sm" onclick="loadConversations()">üîÑ Atualizar</button>
            <button class="btn btn-fire btn-sm" onclick="newConvoModal()">+ Simular Lead</button>
          </div>
        </div>
        <div class="inbox-wrap">
          <!-- LISTA DE CONTATOS -->
          <div class="contact-list">
            <div class="contact-search"><input type="text" id="search-contacts" placeholder="üîç Buscar contato..." oninput="filterContacts(this.value)"/></div>
            <div class="contact-items" id="contactList"></div>
          </div>
          <!-- CHAT PRINCIPAL -->
          <div class="chat-main" id="chatMain">
            <div id="chat-placeholder" style="flex:1;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:12px;color:var(--muted);">
              <div style="font-size:48px;">üí¨</div>
              <div style="font-size:14px;font-weight:600;">Selecione uma conversa</div>
              <div style="font-size:12px;text-align:center;max-width:200px;line-height:1.6;">ou clique em "Simular Lead" para testar o agente</div>
            </div>
            <div id="active-chat" style="display:none;flex-direction:column;height:100%;">
              <div class="chat-header">
                <div class="chat-header-ava" id="ch-ava">üë§</div>
                <div class="chat-header-info">
                  <div class="chat-header-name" id="ch-name">‚Äî</div>
                  <div class="chat-header-sub" id="ch-sub">‚Äî</div>
                </div>
                <div class="chat-header-actions">
                  <button class="btn btn-green btn-xs" onclick="sendToWA(currentContact?.name||'Lead')">üì± Encaminhar</button>
                  <button class="btn btn-ghost btn-xs" onclick="closeChat()">‚úï</button>
                </div>
              </div>
              <div class="chat-win" id="chatWin"></div>
              <div class="chat-bar">
                <textarea class="chat-in" id="chatIn" placeholder="Simular lead (contatos reais respondem via agente n8n)..." rows="1" onkeydown="hkInbox(event)"></textarea>
                <button class="send-b" id="sendBtn" onclick="sendInboxMsg()">‚û§</button>
              </div>
            </div>
          </div>
          <!-- LEAD INFO SIDE -->
          <div class="lead-side" id="leadSide" style="display:none;">
            <div style="padding:13px 16px;border-bottom:1px solid var(--border);font-size:13px;font-weight:700;">üéØ Perfil do Lead</div>
            <div class="lead-info">
              <div class="lead-ava" id="ls-ava">üë§</div>
              <div class="lead-name" id="ls-name">‚Äî</div>
              <div class="lead-sub" id="ls-sub">Aguardando qualifica√ß√£o</div>
              <div class="score-row"><span style="font-size:11px;color:var(--muted);">Score</span><span style="font-weight:700;color:var(--orange);" id="ls-score">0%</span></div>
              <div class="score-track"><div class="score-fill" id="ls-score-fill" style="width:0%"></div></div>
              <div class="tags" id="ls-tags"><span class="tag">üí¨ Aguardando</span></div>
              <div class="ac-row">
                <div style="background:var(--card);border-radius:var(--rs);padding:8px;border:1px solid var(--border);"><div style="font-size:9px;color:var(--muted);margin-bottom:3px;">TEMPERATURA</div><div id="ls-temp" style="font-size:12px;font-weight:700;">‚Äî</div></div>
                <div style="background:var(--card);border-radius:var(--rs);padding:8px;border:1px solid var(--border);"><div style="font-size:9px;color:var(--muted);margin-bottom:3px;">INTEN√á√ÉO</div><div id="ls-intent" style="font-size:12px;font-weight:700;">‚Äî</div></div>
              </div>
              <button class="btn btn-green" style="width:100%;justify-content:center;margin-top:12px;" id="ls-wa-btn" onclick="sendToWA(currentContact?.name||'Lead')" disabled>üì± Encaminhar Vendedor</button>
            </div>
            <div style="padding:10px 14px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);font-size:11px;font-weight:700;color:var(--muted2);">JORNADA DE COMPRA</div>
            <div class="jtrack" id="ls-jtrack">
              <div class="jstep"><div class="jdot todo">üîç</div><div class="ji"><div class="ji-l">Consci√™ncia</div></div></div>
              <div class="jstep"><div class="jdot todo">üí°</div><div class="ji"><div class="ji-l">Interesse</div></div></div>
              <div class="jstep"><div class="jdot todo">‚öñÔ∏è</div><div class="ji"><div class="ji-l">Considera√ß√£o</div></div></div>
              <div class="jstep"><div class="jdot todo">üéØ</div><div class="ji"><div class="ji-l">Decis√£o</div></div></div>
              <div class="jstep"><div class="jdot todo">ü§ù</div><div class="ji"><div class="ji-l">Lead Quente</div></div></div>
            </div>
          </div>
        </div>
      </div>

      <!-- LEADS VIEW -->
      <div class="view" id="view-leads">
        <div class="sec-hdr">
          <div class="sec-title">üë• Todos os Leads</div>
          <button class="btn btn-fire btn-sm" onclick="exportHot()">üî• Exportar Quentes</button>
        </div>
        <div class="panel"><div style="overflow-x:auto;"><table><thead><tr><th>Lead</th><th>Temp</th><th>Score</th><th>Etapa</th><th>Data</th><th>A√ß√£o</th></tr></thead><tbody id="allTbl"></tbody></table></div></div>
      </div>

      <!-- FUNIL VIEW -->
      <div class="view" id="view-funil">
        <div class="sec-title" style="margin-bottom:20px;">üîª Funil de Vendas</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div class="panel">
            <div class="ph"><div class="ph-t">Convers√£o por Etapa</div></div>
            <div style="padding:16px;">
              <div class="funnel-bar"><div class="fb-label">üì¢ Consci√™ncia</div><div class="fb-track"><div class="fb-fill" style="width:100%"></div></div><div class="fb-count">312</div></div>
              <div class="funnel-bar"><div class="fb-label">üí° Interesse</div><div class="fb-track"><div class="fb-fill" style="width:74%"></div></div><div class="fb-count">231</div></div>
              <div class="funnel-bar"><div class="fb-label">‚öñÔ∏è Considera√ß√£o</div><div class="fb-track"><div class="fb-fill" style="width:51%"></div></div><div class="fb-count">159</div></div>
              <div class="funnel-bar"><div class="fb-label">üéØ Decis√£o</div><div class="fb-track"><div class="fb-fill" style="width:30%"></div></div><div class="fb-count">94</div></div>
              <div class="funnel-bar" style="background:rgba(255,101,53,.05);border:1px solid rgba(255,101,53,.1);border-radius:var(--rs);"><div class="fb-label" style="color:var(--orange);">üî• Quente</div><div class="fb-track"><div class="fb-fill" style="width:15%"></div></div><div class="fb-count">47</div></div>
            </div>
          </div>
          <div style="display:flex;flex-direction:column;gap:14px;">
            <div class="panel"><div class="ph"><div class="ph-t">‚ö° Performance</div></div>
              <div style="padding:14px;display:flex;flex-direction:column;gap:8px;">
                <div class="info-row"><span>Resposta m√©dia</span><span style="color:var(--blue);">3.2s</span></div>
                <div class="info-row"><span>Taxa engajamento</span><span style="color:var(--green);">94%</span></div>
                <div class="info-row"><span>Leads/dia</span><span style="color:var(--orange);">28</span></div>
                <div class="info-row"><span>Uptime IA</span><span style="color:var(--green);">100%</span></div>
              </div>
            </div>
            <div class="panel"><div class="ph"><div class="ph-t">üí∞ ROI Estimado</div></div>
              <div style="padding:16px;text-align:center;">
                <div style="font-family:'Bebas Neue';font-size:44px;" class="gt">R$22.400</div>
                <div style="font-size:12px;color:var(--muted);margin-top:4px;">Receita gerada via SDR</div>
                <div style="font-size:14px;color:var(--green);font-weight:700;margin-top:8px;">ROI: 1.623% üöÄ</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- TREINAMENTO VIEW -->
      <div class="view" id="view-treinamento">
        <div class="sec-hdr"><div class="sec-title">üß† Treinamento do Agente IA</div><button class="btn btn-fire btn-sm" onclick="saveTraining()">üíæ Salvar</button></div>
        <div class="panel">
          <div class="ph"><div class="ph-t">‚öôÔ∏è Configura√ß√£o do Agente</div><span style="font-size:11px;color:var(--muted2);">Altera√ß√µes aplicadas em tempo real no n8n</span></div>
          <div class="train-form">
            <div class="ff"><label class="fl">Nome do Neg√≥cio</label><input class="fi" id="t-negocio"/></div>
            <div class="ff"><label class="fl">Persona / Nome do Agente</label><input class="fi" id="t-persona"/></div>
            <div class="ff"><label class="fl">Servi√ßos / Produtos</label><textarea class="fi" id="t-servicos"></textarea></div>
            <div class="ff"><label class="fl">Obje√ß√µes Comuns e Como Contornar</label><textarea class="fi" id="t-objecoes"></textarea></div>
            <div class="ff"><label class="fl">Perguntas de Qualifica√ß√£o</label><textarea class="fi" id="t-perguntas"></textarea></div>
            <div class="row2">
              <div class="ff"><label class="fl">CTA Principal</label><input class="fi" id="t-cta"/></div>
              <div class="ff"><label class="fl">Tom de Comunica√ß√£o</label><select class="fi" id="t-tom"><option>Amig√°vel e Emp√°tico</option><option>Profissional e Formal</option><option>Descontra√≠do e Jovial</option></select></div>
            </div>
            <div class="ff"><label class="fl">Promo√ß√£o / Urg√™ncia atual (opcional)</label><input class="fi" id="t-promo" placeholder="Ex: 20% OFF este m√™s ‚Äî vagas limitadas!"/></div>
            <div style="background:rgba(56,182,255,.05);border:1px solid rgba(56,182,255,.1);border-radius:var(--rs);padding:12px;font-size:12px;color:var(--muted2);line-height:1.6;">
              üí° <strong style="color:var(--white);">Como usar:</strong> Copie o prompt gerado abaixo e cole no campo <code style="color:var(--orange);">System Prompt</code> do n√≥ Code no seu workflow n8n. O agente aplicar√° todas as configura√ß√µes acima.
            </div>
            <button class="btn btn-fire" style="width:100%;justify-content:center;" onclick="saveTraining()">üöÄ Salvar e Gerar Prompt para n8n</button>
            <div id="prompt-output" style="display:none;">
              <div style="font-size:12px;font-weight:700;margin-bottom:8px;color:var(--orange);">üìã Prompt gerado ‚Äî copie para o n8n:</div>
              <textarea class="fi" id="prompt-text" style="min-height:160px;font-size:11px;font-family:monospace;" readonly></textarea>
              <button class="btn btn-ghost btn-sm" style="margin-top:8px;" onclick="copyPrompt()">üìã Copiar Prompt</button>
            </div>
          </div>
        </div>
      </div>

      <!-- ZAPI & WORKFLOW VIEW -->
      <div class="view" id="view-zapi">
        <div class="sec-title" style="margin-bottom:20px;">üì± Zapi & Workflow ‚Äî Controle do Agente</div>

        <!-- STATUS PRINCIPAL -->
        <div class="zapi-status-bar" id="zapi-main-status" style="margin-bottom:20px;">
          <div class="zapi-dot" id="zapi-dot"></div>
          <div style="flex:1;">
            <div style="font-size:15px;font-weight:700;" id="zapi-status-label">‚Äî</div>
            <div style="font-size:12px;color:var(--muted);margin-top:3px;" id="zapi-status-sub">Configure as credenciais abaixo para ativar</div>
          </div>
          <div class="toggle-wrap">
            <button class="toggle" id="main-toggle" onclick="toggleMainAgente(this)"></button>
            <span style="font-size:13px;font-weight:700;" id="main-toggle-lbl">Ativar</span>
          </div>
        </div>

        <!-- CONTROLES R√ÅPIDOS -->
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
          <div class="panel" style="padding:16px;text-align:center;">
            <div style="font-size:24px;margin-bottom:8px;">‚ö°</div>
            <div style="font-size:13px;font-weight:700;margin-bottom:4px;">Workflow n8n</div>
            <div style="font-size:11px;color:var(--muted2);margin-bottom:12px;" id="n8n-workflow-status">Verificar status</div>
            <button class="btn btn-ghost btn-sm" style="width:100%" onclick="openN8nWorkflow()">Abrir n8n ‚Üí</button>
          </div>
          <div class="panel" style="padding:16px;text-align:center;">
            <div style="font-size:24px;margin-bottom:8px;">üì±</div>
            <div style="font-size:13px;font-weight:700;margin-bottom:4px;">Inst√¢ncia Zapi</div>
            <div style="font-size:11px;color:var(--muted2);margin-bottom:12px;" id="zapi-instance-status">Verificar conex√£o</div>
            <button class="btn btn-ghost btn-sm" style="width:100%" onclick="openZapi()">Abrir Zapi ‚Üí</button>
          </div>
          <div class="panel" style="padding:16px;text-align:center;">
            <div style="font-size:24px;margin-bottom:8px;">ü§ñ</div>
            <div style="font-size:13px;font-weight:700;margin-bottom:4px;">Claude AI</div>
            <div style="font-size:11px;color:var(--green);margin-bottom:12px;" id="claude-status">‚óè Conectado</div>
            <button class="btn btn-ghost btn-sm" style="width:100%" onclick="openClaude()">Console ‚Üí</button>
          </div>
        </div>

        <!-- CREDENCIAIS ZAPI -->
        <div class="panel" style="margin-bottom:16px;">
          <div class="ph"><div class="ph-t">üîê Credenciais Zapi desta Inst√¢ncia</div><button class="btn btn-ghost btn-sm" onclick="saveZapiConfig()">üíæ Salvar</button></div>
          <div style="padding:18px;display:flex;flex-direction:column;gap:0;">
            <div class="setup-step"><div class="snum">1</div><div class="si"><div class="si-t">Instance ID</div><div class="si-d">Encontrado na p√°gina da inst√¢ncia em app.z-api.io</div></div><input class="fi" id="zapi-instance" style="width:260px;font-size:11px;font-family:monospace;" placeholder="3EF369ABFE5C321E9910DE26C08F8D63"/></div>
            <div class="setup-step"><div class="snum">2</div><div class="si"><div class="si-t">Token</div><div class="si-d">Token principal da inst√¢ncia</div></div><input class="fi" id="zapi-token" style="width:260px;font-size:11px;font-family:monospace;" placeholder="D8FD069AD1E30FDE0B7624DB"/></div>
            <div class="setup-step" style="border-color:rgba(255,101,53,.2);"><div class="snum">3</div><div class="si"><div class="si-t">Client-Token <span style="color:var(--orange);font-size:10px;">(obrigat√≥rio)</span></div><div class="si-d">Aba Security dentro da inst√¢ncia no Zapi</div></div><input class="fi" id="zapi-client-token" style="width:260px;font-size:11px;font-family:monospace;" placeholder="Fxxxxxxxxxxxxxxxxx"/></div>
            <div class="setup-step"><div class="snum">4</div><div class="si"><div class="si-t">URL do Webhook n8n</div><div class="si-d">Cole no campo "On Message Received" no painel Zapi</div></div><div style="display:flex;gap:8px;align-items:center;"><input class="fi" id="n8n-webhook-url" style="width:280px;font-size:11px;" placeholder="https://usuario.app.n8n.cloud/webhook/zapi"/><button class="btn btn-ghost btn-xs" onclick="copyField('n8n-webhook-url')">Copiar</button></div></div>
            <div class="setup-step"><div class="snum">5</div><div class="si"><div class="si-t">URL Base do n8n</div><div class="si-d">URL da sua inst√¢ncia n8n ‚Äî usada para buscar conversas e status</div></div><input class="fi" id="n8n-base-url" style="width:280px;font-size:11px;" placeholder="https://usuario.app.n8n.cloud"/></div>
            <div class="setup-step" style="border-color:rgba(56,182,255,.2);background:rgba(56,182,255,.03);"><div class="snum" style="background:linear-gradient(135deg,#38b6ff,#8b5cf6);">6</div><div class="si"><div class="si-t">Token de Autentica√ß√£o n8n <span style="color:var(--blue);font-size:10px;">(obrigat√≥rio)</span></div><div class="si-d">Token secreto configurado no n8n para autenticar requisi√ß√µes do app. Defina qualquer string segura (ex: <code style="font-size:10px;">pulsar_abc123</code>) e use o mesmo valor no workflow n8n.</div></div><div style="display:flex;gap:8px;align-items:center;"><input class="fi" id="n8n-auth-token" style="width:260px;font-size:11px;font-family:monospace;" placeholder="pulsar_seutoken_secreto"/><button class="btn btn-ghost btn-xs" onclick="copyField('n8n-auth-token')">Copiar</button></div></div>
          </div>
        </div>

        <!-- FLUXO VISUAL -->
        <div style="background:rgba(56,182,255,.05);border:1px solid rgba(56,182,255,.1);border-radius:var(--r);padding:16px;">
          <div style="font-size:13px;font-weight:700;margin-bottom:10px;color:var(--blue);">üí° Fluxo de funcionamento</div>
          <div style="font-size:12px;color:var(--muted2);line-height:2.0;">
            Lead envia mensagem ‚Üí <strong style="color:var(--white);">Zapi captura</strong> ‚Üí webhook para n8n ‚Üí
            <strong style="color:var(--white);">n8n monta contexto com hist√≥rico</strong> ‚Üí chama <strong style="color:var(--white);">Claude AI</strong> ‚Üí
            resposta volta ao Zapi ‚Üí <strong style="color:var(--white);">entregue ao lead em ~3 segundos</strong><br><br>
            ‚ö†Ô∏è <strong style="color:var(--yellow);">Para pausar o agente:</strong> use o toggle acima ou desative o workflow no n8n. Os dois m√©todos funcionam.
          </div>
        </div>
      </div>

      <!-- CONFIG VIEW -->
      <div class="view" id="view-config">
        <div class="sec-title" style="margin-bottom:6px;">‚öôÔ∏è Configura√ß√µes da Conta</div>
        <div style="max-width:520px;display:flex;flex-direction:column;gap:14px;">
          <div class="panel"><div class="ph"><div class="ph-t">üë§ Dados da Conta</div></div>
            <div style="padding:16px;">
              <div class="ff"><label class="fl">Nome do respons√°vel</label><input class="fi" id="cfg-nome"/></div>
              <div class="ff"><label class="fl">E-mail</label><input class="fi" type="email" id="cfg-email"/></div>
              <div class="ff"><label class="fl">Empresa</label><input class="fi" id="cfg-empresa"/></div>
              <div class="ff"><label class="fl">Nova senha (deixe em branco para manter)</label><div class="pw-wrap"><input class="fi" type="password" id="cfg-nova-senha" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"/><button class="pw-toggle" type="button" onclick="togglePw('cfg-nova-senha',this)">üëÅ</button></div></div>
              <button class="btn btn-ghost btn-sm" onclick="showToast('‚úÖ Dados atualizados!')">Salvar altera√ß√µes</button>
            </div>
          </div>
          <div class="panel"><div class="ph"><div class="ph-t">üì± WhatsApp do Vendedor</div></div>
            <div style="padding:16px;">
              <div style="font-size:12px;color:var(--muted2);margin-bottom:12px;line-height:1.6;">N√∫mero que recebe notifica√ß√£o quando um lead quente √© detectado.</div>
              <div class="ff"><label class="fl">N√∫mero (com DDI)</label><input class="fi" id="waInp" placeholder="5511999999999"/></div>
              <button class="btn btn-fire btn-sm" onclick="saveClientWA()">üíæ Salvar</button>
            </div>
          </div>
          <div class="panel"><div class="ph"><div class="ph-t">üÜò Suporte</div></div>
            <div style="padding:16px;">
              <div style="font-size:13px;color:var(--muted2);margin-bottom:12px;">Fale com a Pulsar Marketing 360.</div>
              <button class="btn btn-green btn-sm" onclick="openSupportWA()">üì± WhatsApp da Ag√™ncia</button>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- MODALS -->
<div class="modal-bg" id="mainModal">
  <div class="modal">
    <div class="m-title" id="mTitle">Novo Cliente</div>
    <div class="m-desc" id="mDesc"></div>
    <div id="mBody"></div>
    <div class="m-btns"><button class="btn btn-ghost" onclick="closeModal()">Cancelar</button><button class="btn btn-fire" id="mOk">Confirmar</button></div>
  </div>
</div>
<div class="confirm-bg" id="confirmModal">
  <div class="confirm-box">
    <div style="font-size:18px;font-weight:700;margin-bottom:8px;color:var(--red);">‚ö†Ô∏è Remover Cliente</div>
    <div style="font-size:13px;color:var(--muted2);margin-bottom:20px;" id="confirm-msg"></div>
    <div style="display:flex;gap:9px;justify-content:flex-end;">
      <button class="btn btn-ghost btn-sm" onclick="closeConfirm()">Cancelar</button>
      <button class="btn btn-red btn-sm" id="confirm-ok">Remover</button>
    </div>
  </div>
</div>
<div class="toast" id="toast"><span id="tMsg"></span></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CREDENCIAIS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AGENCY_EMAIL = 'admin@pulsarmarketing.com';
const AGENCY_PASS  = 'admin123';

const app = {
  apiKey:'', model:'claude-sonnet-4-20250514',
  history:[], score:0, stage:-1, msgCount:0,
  waNumber:'', currentClient:null, isAgency:false,
  agentActive:true,
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENTES (localStorage)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadClients(){
  try{ const s=localStorage.getItem('pulsar_clients'); if(s) return JSON.parse(s); }catch(e){}
  return [
    {id:1,name:'Cl√≠nica Bella',nicho:'clinica',avatar:'üè•',nichoLabel:'üè• Cl√≠nica M√©dica',plan:'pro',planLabel:'PRO',planPrice:1299,status:'active',leads:312,hot:47,conv:24,score:78,email:'joao@clinicabella.com',pass:'cliente123'},
    {id:2,name:'Restaurante Sabor',nicho:'restaurante',avatar:'üçï',nichoLabel:'üçï Restaurante',plan:'basico',planLabel:'B√ÅSICO',planPrice:999,status:'active',leads:198,hot:29,conv:15,score:65,email:'pedro@sabor.com',pass:'cliente123'},
  ];
}
function saveClients(list){ localStorage.setItem('pulsar_clients',JSON.stringify(list)); }
let clients = loadClients();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NICHO DATA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const nichoData = {
  clinica:{name:'Cl√≠nica M√©dica/Est√©tica',negocio:'Cl√≠nica Bella Est√©tica',persona:'Sofia, consultora de est√©tica',servicos:'Botox, Preenchimento labial, Limpeza de pele, Tratamento para manchas',cta:'Agendar avalia√ß√£o gratuita',tom:'emp√°tico e acolhedor',objecoes:'Pre√ßo‚Üíparcelamento+autoestima | Medo‚Üíseguran√ßa e depoimentos'},
  restaurante:{name:'Restaurante',negocio:'Restaurante do Chef',persona:'Lucas, consultor gastron√¥mico',servicos:'Almo√ßo executivo, Jantar √† la carte, Eventos corporativos',cta:'Confirmar uma reserva',tom:'caloroso e sofisticado',objecoes:'Pre√ßo‚Üíexperi√™ncia √∫nica | Dist√¢ncia‚Üívale a pena'},
  academia:{name:'Academia/Fitness',negocio:'Academia FitLife',persona:'Rafael, personal trainer',servicos:'Muscula√ß√£o, Personal training, Aulas coletivas, Nutri√ß√£o',cta:'Agendar aula experimental gratuita',tom:'motivador e energ√©tico',objecoes:'Tempo‚Üí30min/dia | Pre√ßo‚Üíinvestimento na sa√∫de'},
  advocacia:{name:'Advocacia',negocio:'Escrit√≥rio Jur√≠dico',persona:'Dr. Andr√©, consultor jur√≠dico',servicos:'Direito trabalhista, Direito civil, Contratos',cta:'Agendar consulta inicial gratuita',tom:'profissional e confiante',objecoes:'Custo‚Üíhonor√°rios s√≥ no ganho | Demora‚Üíprazos claros'},
  imoveis:{name:'Imobili√°ria',negocio:'Prime Im√≥veis',persona:'Ana, consultora imobili√°ria',servicos:'Compra, venda, aluguel residencial e comercial',cta:'Agendar visita ao im√≥vel',tom:'consultivo e seguro',objecoes:'Indecis√£o‚Üímomento do mercado | Financiamento‚Üíparceiros especiais'},
  salao:{name:'Sal√£o de Beleza',negocio:'Studio Hair',persona:'Camila, consultora de beleza',servicos:'Corte, colora√ß√£o, escova, manicure, maquiagem',cta:'Agendar hor√°rio',tom:'descontra√≠do e criativo',objecoes:'Pre√ßo‚Üíqualidade e durabilidade | Hor√°rio‚Üíagenda flex√≠vel'},
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CONVERSAS ‚Äî POR CLIENTE, PERSISTIDAS NO LOCALSTORAGE
// + INTEGRA√á√ÉO REAL COM Z-API
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Conversas s√£o SEMPRE isoladas por cliente via localStorage
// Chave: pulsar_contacts_{clientId}

function getClientContacts(clientId){
  try{const s=localStorage.getItem('pulsar_contacts_'+clientId);if(s)return JSON.parse(s);}catch(e){}
  return []; // novo cliente = inbox vazio
}
function saveClientContacts(clientId,data){
  localStorage.setItem('pulsar_contacts_'+clientId,JSON.stringify(data));
}

let contactsData = []; // sempre resetado ao trocar de cliente
let currentContact = null;
let chatHistory = [];
let chatScore = 0;
let chatStage = -1;
let chatMsgCount = 0;

// LeadsData derivado dos contatos reais
function getLeadsData(){
  return contactsData.map(c=>({
    name:c.name,biz:c.lastMsg||'‚Äî',temp:c.temp,score:c.score,
    stage:['Consci√™ncia','Interesse','Considera√ß√£o','Decis√£o','üî• Quente'][Math.min(c.stage+1,4)]||'‚Äî',
    date:c.time,phone:c.phone
  }));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INTEGRA√á√ÉO VIA N8N COMO PROXY
//
// O browser N√ÉO pode chamar o Z-API diretamente (CORS bloqueado).
// O n8n age como intermedi√°rio:
//   App ‚Üí n8n webhook ‚Üí n8n chama Z-API ‚Üí retorna JSON ao app
//
// URLs configuradas pelo cliente na aba Zapi & Workflow:
//   n8n Base URL: https://usuario.app.n8n.cloud
//   Endpoints esperados:
//     GET  {base}/webhook/pulsar-status    ‚Üí status da conex√£o
//     GET  {base}/webhook/pulsar-chats     ‚Üí lista de chats
//     GET  {base}/webhook/pulsar-messages?phone=xxx ‚Üí hist√≥rico
//     POST {base}/webhook/pulsar-send      ‚Üí enviar mensagem manual
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function getN8nBase(){
  const c=app.currentClient;if(!c)return null;
  const zapi=JSON.parse(localStorage.getItem('pulsar_zapi_'+c.id)||'{}');
  return zapi.n8nBase?.replace(/\/$/,'')||null;
}
function getN8nToken(){
  const c=app.currentClient;if(!c)return '';
  const zapi=JSON.parse(localStorage.getItem('pulsar_zapi_'+c.id)||'{}');
  return zapi.n8nAuthToken||''; // token dedicado para autenticar chamadas app‚Üín8n
}

async function n8nGet(endpoint,params){
  const base=getN8nBase();if(!base)return null;
  const token=getN8nToken();
  let url=base+endpoint;
  const allParams={...params||{},...(token?{token}:{})};
  if(Object.keys(allParams).length){const q=new URLSearchParams(allParams);url+='?'+q;}
  try{
    const r=await fetch(url,{
      headers:{
        'Content-Type':'application/json',
        ...(token?{'x-pulsar-token':token}:{})
      }
    });
    if(!r.ok){console.warn('n8n GET error:',r.status,url);return null;}
    return await r.json();
  }catch(e){console.warn('n8n GET failed:',e.message);return null;}
}

async function n8nPost(endpoint,body){
  const base=getN8nBase();if(!base)return null;
  const token=getN8nToken();
  const url=base+endpoint;
  try{
    const r=await fetch(url,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        ...(token?{'x-pulsar-token':token}:{})
      },
      body:JSON.stringify(body)
    });
    if(!r.ok){console.warn('n8n POST error:',r.status);return null;}
    return await r.json();
  }catch(e){console.warn('n8n POST failed:',e.message);return null;}
}

// Verifica status de conex√£o via n8n
async function checkZapiStatus(){
  const base=getN8nBase();
  if(!base){updateZapiStatusUI(false,null);return false;}
  const tok=getN8nToken();
  if(!tok){
    const sub=document.getElementById('zapi-status-sub');
    if(sub)sub.textContent='‚ö†Ô∏è Configure o Token de Autentica√ß√£o n8n (campo 6)';
    updateZapiStatusUI(false,null);return false;
  }
  const data=await n8nGet('/webhook/pulsar-status');
  const connected=data?.connected===true||data?.status==='CONNECTED'||data?.value==='CONNECTED';
  updateZapiStatusUI(connected,data);
  return connected;
}

function updateZapiStatusUI(connected,data){
  const lbl=document.getElementById('zapi-status-label');
  const sub=document.getElementById('zapi-status-sub');
  const dot=document.getElementById('zapi-dot');
  const bar=document.getElementById('zapi-main-status');
  const istat=document.getElementById('zapi-instance-status');
  if(connected){
    if(lbl)lbl.textContent='Zapi ‚Äî WhatsApp Conectado ‚úÖ';
    if(sub)sub.textContent='Recebendo e respondendo mensagens via n8n + Z-API';
    if(dot)dot.className='zapi-dot zapi-dot-on';
    if(bar)bar.style.borderColor='rgba(0,230,118,.25)';
    if(istat)istat.textContent='‚óè Conectado';
    if(istat)istat.style.color='var(--green)';
  }else{
    const base=getN8nBase();
    if(lbl)lbl.textContent=base?'‚ö†Ô∏è n8n ‚Äî Sem resposta do endpoint':'Configure a URL do n8n abaixo';
    if(sub)sub.textContent=base?'Verifique se o workflow pulsar-status est√° ativo no n8n':'Preencha a URL Base do n8n para ativar a integra√ß√£o';
    if(dot)dot.className='zapi-dot zapi-dot-off';
    if(istat)istat.textContent=base?'‚ö†Ô∏è Sem resposta':'N√£o configurado';
    if(istat)istat.style.color=base?'var(--yellow)':'var(--muted)';
  }
}

// Busca conversas reais via n8n ‚Üí Z-API
async function fetchZapiChats(){
  const btn=document.getElementById('btn-load-zapi');
  if(btn){btn.disabled=true;btn.textContent='‚è≥ Buscando...';}
  showToast('üîÑ Buscando conversas via n8n...');

  const base=getN8nBase();
  if(!base){
    showToast('‚ö†Ô∏è Configure a URL Base do n8n na aba Zapi & Workflow');
    if(btn){btn.disabled=false;btn.textContent='üì≤ Sincronizar WhatsApp';}
    return;
  }

  const data=await n8nGet('/webhook/pulsar-chats');
  if(btn){btn.disabled=false;btn.textContent='üì≤ Sincronizar WhatsApp';}

  if(!data){
    showToast('‚ö†Ô∏è n8n n√£o respondeu ‚Äî verifique se o workflow pulsar-chats est√° ativo');
    return;
  }

  const c=app.currentClient;if(!c)return;

  // Parsing defensivo ‚Äî workflow retorna {chats:[...]} OU array direto
  let chats=[];
  if(data&&!Array.isArray(data)&&typeof data==='object'){
    chats=data.chats||data.value||data.data||[];
  }else if(Array.isArray(data)){
    if(data.length>0&&data[0]&&data[0].json&&data[0].json.chats) chats=data[0].json.chats;
    else if(data.length>0&&(data[0].phone||data[0].id)) chats=data;
    else chats=data;
  }
  if(!Array.isArray(chats))chats=[];
  console.log('[Pulsar] chats recebidos:',chats.length,'raw:',JSON.stringify(data).slice(0,150));

  if(!chats.length){showToast('üì≠ Nenhuma conversa encontrada. Verifique se o WhatsApp est√° conectado no Zapi.');return;}

  // Carrega lista PRIMEIRO (r√°pido) ‚Äî hist√≥rico carregado lazy ao abrir conversa
  let added=0;
  for(const chat of chats.slice(0,60)){
    const rawId=chat.phone||chat.id||'';
    if(rawId.indexOf('@g.us')>=0||rawId.indexOf('-')>=0)continue; // grupos
    const phone=rawId.replace('@c.us','').replace(/[^0-9]/g,'');
    if(!phone||phone.length<8||phone.length>15)continue;
    const name=chat.name||chat.pushName||chat.senderName||formatPhone(phone);
    const existing=contactsData.find(x=>x.phone===phone);
    // Z-API retorna lastMessageTime em milissegundos (n√£o segundos)
    const tsRaw=parseInt(chat.lastMessageTime||chat.timestamp||0,10);
    const ts=tsRaw>9999999999?tsRaw/1000:tsRaw; // converte ms‚Üís se necess√°rio
    const lastTxt=chat.text||chat.body||'...';

    if(!existing){
      contactsData.unshift({
        id:'zapi_'+phone,name,phone,
        avatar:getAvatar(name),
        lastMsg:lastTxt,
        time:formatTime(ts),
        unread:parseInt(chat.messagesUnread||chat.unreadCount||'0',10),
        score:0,stage:-1,temp:'cold',
        nicho:c.nicho||'geral',
        history:[],
        historyLoaded:false,
        fromZapi:true
      });
      added++;
    }else{
      existing.lastMsg=lastTxt||existing.lastMsg;
      existing.unread=chat.unreadCount||existing.unread;
      existing.time=formatTime(ts);
      existing.fromZapi=true;
    }
  }

  saveClientContacts(c.id,contactsData);
  renderContactList();
  renderHotTable();renderAllTable();
  updateInboxBadges();
  showToast(added>0?`‚úÖ ${added} contatos do WhatsApp carregados!`:'‚úÖ Lista de contatos atualizada!');
}

// Busca hist√≥rico de mensagens via n8n ‚Äî workflow retorna {messages:[...]}
async function fetchZapiHistory(phone){
  const data=await n8nGet('/webhook/pulsar-messages',{phone});
  if(!data)return[];
  // Parsing defensivo igual ao fetchZapiChats
  let msgs=[];
  if(data&&!Array.isArray(data)&&typeof data==='object'){
    msgs=data.messages||data.value||data.data||[];
  }else if(Array.isArray(data)){
    if(data.length>0&&data[0]&&data[0].json&&data[0].json.messages) msgs=data[0].json.messages;
    else if(data.length>0&&(data[0].role||data[0].content||data[0].fromMe!==undefined)) msgs=data;
    else msgs=data;
  }
  if(!Array.isArray(msgs))msgs=[];
  console.log('[Pulsar] mensagens:',msgs.length,'para',phone);
  return msgs
    .map(m=>({
      role:m.fromMe?'assistant':'user',
      content:(m.text&&m.text.message)||m.text||m.message||m.body||m.content||'',
      timestamp:m.timestamp||0,
      isFromZapi:true
    }))
    .filter(m=>m.content&&m.content.trim().length>0);
  // SEM .reverse() ‚Äî o workflow n8n j√° retorna em ordem cronol√≥gica
}

// Atualiza mensagens do contato aberto
async function refreshContactMessages(phone){
  const msgs=await fetchZapiHistory(phone);
  if(!msgs||!msgs.length)return;
  const c=app.currentClient;if(!c)return;
  const contact=contactsData.find(x=>x.phone===phone);
  if(!contact)return;
  const prevCount=contact.history.length;
  contact.history=msgs;
  contact.historyLoaded=true;
  saveClientContacts(c.id,contactsData);
  if(currentContact&&currentContact.phone===phone&&msgs.length!==prevCount){
    chatHistory=[...msgs];
    const win=document.getElementById('chatWin');
    if(win){
      win.innerHTML='';
      chatHistory.forEach(m=>renderBubble(m.role==='assistant'?'ai':'lead',m.content,false));
      win.scrollTop=win.scrollHeight;
    }
  }
}

// Envia mensagem manual via n8n ‚Üí Z-API (resposta do vendedor)
async function sendManualReply(phone,message){
  if(!phone||!message)return false;
  const result=await n8nPost('/webhook/pulsar-send',{phone,message});
  return result?.sent===true||result?.success===true||!!result;
}

// ‚îÄ‚îÄ POLLING AUTOM√ÅTICO (via n8n) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pollingInterval=null;
function startPolling(){
  if(pollingInterval)clearInterval(pollingInterval);
  const base=getN8nBase();
  if(!base)return; // sem n8n configurado, sem polling
  window._pollCount=0;
  pollingInterval=setInterval(async()=>{
    if(!app.currentClient)return;
    window._pollCount=(window._pollCount||0)+1;
    // A cada poll: atualiza mensagens do contato aberto
    if(currentContact?.fromZapi){
      await refreshContactMessages(currentContact.phone);
    }
    // A cada 4 polls (~60s): verifica novos chats
    if(window._pollCount%4===0){
      const data=await n8nGet('/webhook/pulsar-chats');
      if(data){
        const chats=Array.isArray(data)?data:(data.chats||data.value||[]);
        let changed=false;
        for(const chat of chats.slice(0,20)){
          const phone=(chat.phone||chat.id||'').replace('@c.us','').replace(/\D/g,'');
          if(!phone||phone.includes('g.us'))continue;
          const existing=contactsData.find(x=>x.phone===phone);
          if(existing){
            if((chat.unreadCount||0)>existing.unread){
              existing.unread=chat.unreadCount;changed=true;
              existing.lastMsg=chat.text||chat.body||existing.lastMsg;
              existing.time=formatTime(chat.lastMessage?.timestamp||Date.now()/1000);
            }
          }else if((chat.unreadCount||0)>0){
            const name=chat.name||chat.pushName||formatPhone(phone);
            const msgs=await fetchZapiHistory(phone);
            contactsData.unshift({
              id:'zapi_'+phone,name,phone,avatar:getAvatar(name),
              lastMsg:chat.text||chat.body||'Nova mensagem',
              time:'Agora',unread:parseInt(chat.messagesUnread||chat.unreadCount||0,10),score:0,stage:-1,temp:'cold',
              nicho:app.currentClient?.nicho||'geral',history:msgs,fromZapi:true
            });
            changed=true;
            showToast('üí¨ Nova mensagem de '+name);
          }
        }
        if(changed){
          saveClientContacts(app.currentClient?.id,contactsData);
          renderContactList();updateInboxBadges();
        }
      }
    }
  },15000);
}
function stopPolling(){
  if(pollingInterval){clearInterval(pollingInterval);pollingInterval=null;}
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function formatPhone(phone){return phone?'+'+phone:'‚Äî';}
function getAvatar(name){
  const avatars=['üë§','üë©','üë®','üë©‚Äçüíº','üë®‚Äçüíº','üíÅ‚Äç‚ôÄÔ∏è','üßë','üë±‚Äç‚ôÄÔ∏è','üë±','üßî'];
  const idx=name?.charCodeAt(0)%avatars.length||0;return avatars[idx];
}
function formatTime(ts){
  if(!ts)return'‚Äî';
  const d=new Date(ts>9999999999?ts:ts*1000);
  const now=new Date();
  const diff=now-d;
  if(diff<60000)return'Agora';
  if(diff<3600000)return Math.floor(diff/60000)+'min';
  if(d.toDateString()===now.toDateString())return d.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  const yesterday=new Date(now);yesterday.setDate(now.getDate()-1);
  if(d.toDateString()===yesterday.toDateString())return'Ontem';
  return d.toLocaleDateString('pt-BR',{day:'2-digit',month:'2-digit'});
}
function updateInboxBadges(){
  const unread=contactsData.filter(x=>x.unread>0).length;
  const hot=contactsData.filter(x=>x.temp==='hot').length;
  const icount=document.getElementById('inbox-count');
  const lcount=document.getElementById('leads-count');
  if(icount)icount.textContent=unread;
  if(lcount)lcount.textContent=hot;
  const dac=document.getElementById('dash-active-conv');
  if(dac)dac.textContent=contactsData.filter(x=>x.unread>0).length;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// LOGIN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setLoginTab(type,el){
  document.querySelectorAll('.ltab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('login-agency-form').style.display=type==='agency'?'block':'none';
  document.getElementById('login-client-form').style.display=type==='client'?'block':'none';
  ['ag-err','cl-err'].forEach(id=>document.getElementById(id).style.display='none');
}
function loginAgency(){
  const e=document.getElementById('ag-email').value.trim();
  const p=document.getElementById('ag-pass').value;
  if(e===AGENCY_EMAIL&&p===AGENCY_PASS){
    app.isAgency=true;
    document.getElementById('ag-err').style.display='none';
    const sk=localStorage.getItem('pulsar_agency_apikey')||'';
    const sm=localStorage.getItem('pulsar_agency_model')||'claude-sonnet-4-20250514';
    if(sk){document.getElementById('agencyApiKey').value=sk;app.apiKey=sk;}
    document.getElementById('agencyModel').value=sm;app.model=sm;
    updateApiStatusBadge(sk);
    clients=loadClients();renderClients();updateAgencyStats();showScreen('agency');
  }else{document.getElementById('ag-err').style.display='block';}
}
function loginClient(){
  const e=document.getElementById('cl-email').value.trim().toLowerCase();
  const p=document.getElementById('cl-pass').value;
  clients=loadClients();
  const client=clients.find(c=>c.email.toLowerCase()===e&&c.pass===p);
  if(client){
    document.getElementById('cl-err').style.display='none';
    app.isAgency=false;app.currentClient=client;
    app.apiKey=localStorage.getItem('pulsar_agency_apikey')||'';
    app.model=localStorage.getItem('pulsar_agency_model')||'claude-sonnet-4-20250514';
    loadClientPanel(client);showScreen('client');
  }else{document.getElementById('cl-err').style.display='block';}
}
function loadClientPanel(client){
  // ‚îÄ‚îÄ PARA polling do cliente anterior ‚îÄ‚îÄ
  stopPolling();
  currentContact=null;

  document.getElementById('sb-client-name').textContent=client.name;
  document.getElementById('d-conversas').textContent=client.leads;
  document.getElementById('d-hot').textContent=client.hot;
  document.getElementById('d-conv').textContent=client.conv;
  document.getElementById('cfg-email').value=client.email;
  document.getElementById('cfg-empresa').value=client.name;

  // ‚îÄ‚îÄ CARREGA CONTATOS DO CLIENTE (isolado por id) ‚îÄ‚îÄ
  contactsData=getClientContacts(client.id);

  updateInboxBadges();

  // ‚îÄ‚îÄ TRAINING ‚îÄ‚îÄ
  const nicho=client.nicho||'clinica';
  const nd=nichoData[nicho]||nichoData.clinica;
  // Tenta carregar training salvo primeiro
  const savedTraining=JSON.parse(localStorage.getItem('pulsar_training_'+client.id)||'{}');
  document.getElementById('t-negocio').value=savedTraining.negocio||nd.negocio;
  document.getElementById('t-persona').value=savedTraining.persona||nd.persona;
  document.getElementById('t-servicos').value=savedTraining.servicos||nd.servicos;
  document.getElementById('t-objecoes').value=savedTraining.objecoes||nd.objecoes;
  document.getElementById('t-perguntas').value=savedTraining.perguntas||'Qual √© seu principal objetivo?\nJ√° fez algum procedimento antes?\nTem alguma data especial se aproximando?';
  document.getElementById('t-cta').value=savedTraining.cta||nd.cta;
  document.getElementById('t-tom').value=savedTraining.tom||nd.tom||'profissional';

  // ‚îÄ‚îÄ ZAPI CONFIG ‚îÄ‚îÄ
  const zapi=JSON.parse(localStorage.getItem('pulsar_zapi_'+client.id)||'{}');
  if(zapi.instance)document.getElementById('zapi-instance').value=zapi.instance;
  if(zapi.token)document.getElementById('zapi-token').value=zapi.token;
  if(zapi.clientToken)document.getElementById('zapi-client-token').value=zapi.clientToken;
  if(zapi.webhookUrl)document.getElementById('n8n-webhook-url').value=zapi.webhookUrl;
  if(zapi.n8nBase)document.getElementById('n8n-base-url').value=zapi.n8nBase;
  if(zapi.n8nAuthToken)document.getElementById('n8n-auth-token').value=zapi.n8nAuthToken;
  const active=zapi.active!==false;
  app.agentActive=active;
  updateAgentToggleUI(active);

  // ‚îÄ‚îÄ INBOX: fecha chat aberto ‚îÄ‚îÄ
  const chatEl=document.getElementById('active-chat');
  const phEl=document.getElementById('chat-placeholder');
  const lsEl=document.getElementById('leadSide');
  if(chatEl)chatEl.style.display='none';
  if(phEl)phEl.style.display='flex';
  if(lsEl)lsEl.style.display='none';

  renderContactList();
  renderHotTable();
  renderAllTable();

  // ‚îÄ‚îÄ VERIFICA STATUS E INICIA POLLING ‚îÄ‚îÄ
  const hasN8n=!!(zapi.n8nBase&&zapi.n8nAuthToken);
  const hasZapi=!!(zapi.instance&&zapi.token&&zapi.clientToken);
  if(hasN8n||hasZapi){
    checkZapiStatus();
    if(active)startPolling();
  }else{
    updateZapiStatusUI(false,null);
  }
}
function backToAgency(){
  stopPolling();contactsData=[];currentContact=null;
  if(app.isAgency){clients=loadClients();renderClients();updateAgencyStats();showScreen('agency');}
  else logout();
}
function logout(){stopPolling();contactsData=[];currentContact=null;showScreen('login');app.currentClient=null;app.isAgency=false;}
function showScreen(id){document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));document.getElementById('screen-'+id).classList.add('active');}
function togglePw(id,btn){const inp=document.getElementById(id);if(!inp)return;inp.type=inp.type==='password'?'text':'password';btn.textContent=inp.type==='password'?'üëÅ':'üôà';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGENT TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleAgente(btn){
  app.agentActive=!app.agentActive;
  updateAgentToggleUI(app.agentActive);
  saveZapiState();
  if(app.agentActive){startPolling();}else{stopPolling();}
  showToast(app.agentActive?'‚úÖ Agente ativado ‚Äî respondendo leads!':'‚è∏Ô∏è Agente pausado ‚Äî n√£o responder√° novas mensagens.');
}
function toggleMainAgente(btn){
  app.agentActive=!app.agentActive;
  updateAgentToggleUI(app.agentActive);
  saveZapiState();
  if(app.agentActive){startPolling();}else{stopPolling();}
  showToast(app.agentActive?'‚úÖ Agente ativado!':'‚è∏Ô∏è Agente pausado!');
}
function updateAgentToggleUI(active){
  ['agente-toggle','main-toggle'].forEach(id=>{
    const t=document.getElementById(id);if(t){t.classList.toggle('on',active);}
  });
  const lbl=document.getElementById('agente-toggle-label');
  if(lbl)lbl.textContent=active?'Agente ativo':'Agente pausado';
  const mlbl=document.getElementById('main-toggle-lbl');
  if(mlbl)mlbl.textContent=active?'Pausar':'Ativar';
  // Sidebar badge
  const badge=document.getElementById('ai-status-badge');
  const pring=document.getElementById('pring-dot');
  const stext=document.getElementById('ai-status-text');
  if(badge){badge.className='ai-live'+(active?'':' ai-paused');}
  if(pring){pring.className='pring'+(active?'':' pring-y');}
  if(stext)stext.textContent=active?'IA ATIVA 24/7':'IA PAUSADA';
  // Zapi status bar
  const zbar=document.getElementById('zapi-main-status');
  const zdot=document.getElementById('zapi-dot');
  const zlbl=document.getElementById('zapi-status-label');
  const zsub=document.getElementById('zapi-status-sub');
  if(zbar){zbar.className='zapi-status-bar '+(active?'zapi-on':'zapi-off');}
  if(zdot){zdot.className='zapi-dot '+(active?'zapi-dot-on':'zapi-dot-off');}
  if(zlbl)zlbl.textContent=active?'Zapi + n8n ‚Äî Agente Ativo':'‚è∏Ô∏è Agente Pausado';
  if(zsub)zsub.textContent=active?'Recebendo e respondendo mensagens 24/7':'Use o toggle para reativar o agente';
  // Dashboard status
  const dst=document.getElementById('dash-agent-status');
  const dstxt=document.getElementById('dash-status-text');
  const n8nst=document.getElementById('dash-n8n-status');
  if(dst)dst.style.background=active?'rgba(0,230,118,.06)':'rgba(255,211,42,.06)';
  if(dst)dst.style.borderColor=active?'rgba(0,230,118,.15)':'rgba(255,211,42,.2)';
  if(dstxt){dstxt.textContent=active?'Agente Ativo ‚Äî Respondendo leads':'‚è∏Ô∏è Agente Pausado';dstxt.style.color=active?'var(--green)':'var(--yellow)';}
  if(n8nst){n8nst.textContent=active?'‚óè Ativo':'‚è∏ Pausado';n8nst.style.color=active?'var(--green)':'var(--yellow)';}
}
function saveZapiState(){
  const c=app.currentClient;if(!c)return;
  const key='pulsar_zapi_'+c.id;
  const cur=JSON.parse(localStorage.getItem(key)||'{}');
  cur.active=app.agentActive;
  localStorage.setItem(key,JSON.stringify(cur));
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// AGENCY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderClients(){
  const grid=document.getElementById('clientsGrid');
  const colors=['#ff6535','#38b6ff','#00e676','#e8369b','#8b5cf6','#ffd32a'];
  const planCls={basico:'plan-basico',pro:'plan-pro',premium:'plan-premium'};
  const stCls={active:'pill-active',trial:'pill-trial',paused:'pill-paused'};
  const stLbl={active:'‚óè Ativo',trial:'‚óè Trial',paused:'‚óè Pausado'};
  grid.innerHTML=clients.map((c,i)=>`
    <div class="client-card">
      <div class="cc-top">
        <div class="cc-avatar" style="background:${colors[i%colors.length]}22;border:1px solid ${colors[i%colors.length]}44;">${c.avatar}</div>
        <div class="cc-info"><div class="cc-name">${c.name}</div><div class="cc-nicho">${c.nichoLabel}</div><div class="cc-email">üìß ${c.email}</div></div>
        <div style="display:flex;flex-direction:column;gap:4px;align-items:flex-end;">
          <span class="pill ${stCls[c.status]}">${stLbl[c.status]}</span>
          <span class="plan-badge ${planCls[c.plan]}">${c.planLabel}</span>
        </div>
      </div>
      <div class="cc-metrics">
        <div class="ccm"><div class="ccm-val">${c.leads}</div><div class="ccm-lbl">Leads</div></div>
        <div class="ccm"><div class="ccm-val" style="color:var(--pink);">${c.hot}</div><div class="ccm-lbl">Quentes</div></div>
        <div class="ccm"><div class="ccm-val" style="color:var(--green);">${c.conv}</div><div class="ccm-lbl">Fechados</div></div>
      </div>
      <div class="cc-bar"><div class="cc-bar-fill" style="width:${c.score}%"></div></div>
      <div class="cc-actions">
        <button class="btn btn-ghost btn-xs" onclick="openClientAsAgency(${c.id})">üìä Painel</button>
        <button class="btn btn-ghost btn-xs" onclick="editClientModal(${c.id})">‚úèÔ∏è Editar</button>
        <button class="btn btn-red btn-xs" onclick="confirmDelete(${c.id},'${c.name.replace(/'/g,"\\'")}')">üóëÔ∏è</button>
      </div>
    </div>
  `).join('')+`<div class="add-client-card" onclick="addClientModal()"><span style="font-size:32px;">‚ûï</span><div style="font-size:14px;font-weight:600;">Adicionar Cliente</div><div style="font-size:11px;text-align:center;max-width:160px;line-height:1.5;">Configure um novo agente SDR em minutos</div></div>`;
}
function updateAgencyStats(){
  const active=clients.filter(c=>c.status==='active');
  const mrr=active.reduce((s,c)=>s+(c.planPrice||0),0);
  const leads=clients.reduce((s,c)=>s+(c.leads||0),0);
  const hot=clients.reduce((s,c)=>s+(c.hot||0),0);
  const iaCost=Math.round(active.length*25);
  const margem=mrr-iaCost-150;
  document.getElementById('stat-clientes').textContent=active.length;
  document.getElementById('stat-clientes-sub').textContent=active.length>0?`‚Üë ${active.length} ativo(s)`:'Nenhum ainda';
  document.getElementById('stat-leads').textContent=leads.toLocaleString('pt-BR');
  document.getElementById('stat-hot').textContent=hot;
  document.getElementById('stat-mrr').textContent='R$'+mrr.toLocaleString('pt-BR');
  document.getElementById('activeClientsCount').textContent=active.length;
  document.getElementById('ia-cost').textContent='~R$'+iaCost;
  document.getElementById('mrrDisplay').textContent='R$'+mrr.toLocaleString('pt-BR');
  document.getElementById('margem-display').textContent='R$'+Math.max(margem,0).toLocaleString('pt-BR');
}
function openClientAsAgency(id){
  const c=clients.find(x=>x.id===id);if(!c)return;
  app.currentClient=c;app.isAgency=true;
  loadClientPanel(c);showScreen('client');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// CLIENT MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clientFormHTML(c){
  const planOpts=[{v:'basico',l:'B√°sico ‚Äî R$999/m√™s'},{v:'pro',l:'Pro ‚Äî R$1.299/m√™s'},{v:'premium',l:'Premium ‚Äî R$1.499/m√™s'}];
  const nichoOpts=[{v:'clinica',l:'üè• Cl√≠nica'},{v:'restaurante',l:'üçï Restaurante'},{v:'academia',l:'üí™ Academia'},{v:'advocacia',l:'‚öñÔ∏è Advocacia'},{v:'imoveis',l:'üè† Im√≥veis'},{v:'salao',l:'üíá Sal√£o'}];
  return`
    <div class="ff"><label class="fl">Nome do Neg√≥cio *</label><input class="fi" id="nc-name" value="${c?c.name:''}"/></div>
    <div class="ff"><label class="fl">Nicho</label><select class="fi" id="nc-nicho">${nichoOpts.map(n=>`<option value="${n.v}"${c&&c.nicho===n.v?' selected':''}>${n.l}</option>`).join('')}</select></div>
    <div class="row2">
      <div class="ff"><label class="fl">Plano</label><select class="fi" id="nc-plan">${planOpts.map(p=>`<option value="${p.v}"${c&&c.plan===p.v?' selected':''}>${p.l}</option>`).join('')}</select></div>
      <div class="ff"><label class="fl">Status</label><select class="fi" id="nc-status"><option value="active"${!c||c.status==='active'?' selected':''}>‚úÖ Ativo</option><option value="trial"${c&&c.status==='trial'?' selected':''}>üü° Trial</option><option value="paused"${c&&c.status==='paused'?' selected':''}>‚è∏Ô∏è Pausado</option></select></div>
    </div>
    <div class="ff"><label class="fl">E-mail de acesso *</label><input class="fi" id="nc-email" type="email" value="${c?c.email:''}"/></div>
    <div class="ff"><label class="fl">${c?'Nova senha (em branco = manter)':'Senha *'}</label><div class="pw-wrap"><input class="fi" type="password" id="nc-pass" autocomplete="new-password"/><button class="pw-toggle" type="button" onclick="togglePw('nc-pass',this)">üëÅ</button></div></div>
    ${!c?'<div style="font-size:11px;color:var(--muted2);background:rgba(56,182,255,.05);border:1px solid rgba(56,182,255,.1);border-radius:var(--rs);padding:10px;margin-top:-8px;">üí° O navegador do cliente pode salvar a senha automaticamente no primeiro login.</div>':''}
  `;
}
function addClientModal(){document.getElementById('mTitle').textContent='‚ûï Novo Cliente';document.getElementById('mDesc').textContent='Configure o acesso do cliente ao painel Pulsar SDR.';document.getElementById('mBody').innerHTML=clientFormHTML(null);document.getElementById('mOk').textContent='üöÄ Criar';document.getElementById('mOk').onclick=confirmAddClient;document.getElementById('mainModal').classList.add('open');}
function editClientModal(id){const c=clients.find(x=>x.id===id);if(!c)return;document.getElementById('mTitle').textContent='‚úèÔ∏è Editar Cliente';document.getElementById('mDesc').textContent=`Editando: ${c.name}`;document.getElementById('mBody').innerHTML=clientFormHTML(c);document.getElementById('mOk').textContent='üíæ Salvar';document.getElementById('mOk').onclick=()=>confirmEditClient(id);document.getElementById('mainModal').classList.add('open');}
const nichoAvatars={clinica:'üè•',restaurante:'üçï',academia:'üí™',advocacia:'‚öñÔ∏è',imoveis:'üè†',salao:'üíá'};
const nichoLabels={clinica:'üè• Cl√≠nica M√©dica',restaurante:'üçï Restaurante',academia:'üí™ Academia',advocacia:'‚öñÔ∏è Advocacia',imoveis:'üè† Im√≥veis',salao:'üíá Sal√£o'};
const planLabels={basico:'B√ÅSICO',pro:'PRO',premium:'PREMIUM'};
const planPrices={basico:999,pro:1299,premium:1499};
function confirmAddClient(){
  const name=document.getElementById('nc-name')?.value?.trim();
  const email=document.getElementById('nc-email')?.value?.trim();
  const pass=document.getElementById('nc-pass')?.value;
  if(!name){showToast('‚ö†Ô∏è Preencha o nome');return;}
  if(!email){showToast('‚ö†Ô∏è Preencha o e-mail');return;}
  if(!pass||pass.length<6){showToast('‚ö†Ô∏è Senha m√≠nima de 6 caracteres');return;}
  const nicho=document.getElementById('nc-nicho')?.value||'clinica';
  const plan=document.getElementById('nc-plan')?.value||'basico';
  const status=document.getElementById('nc-status')?.value||'active';
  clients.push({id:Date.now(),name,nicho,avatar:nichoAvatars[nicho],nichoLabel:nichoLabels[nicho],plan,planLabel:planLabels[plan],planPrice:planPrices[plan],status,leads:0,hot:0,conv:0,score:0,email,pass});
  saveClients(clients);closeModal();renderClients();updateAgencyStats();showToast(`‚úÖ Cliente "${name}" criado!`);
}
function confirmEditClient(id){
  const idx=clients.findIndex(x=>x.id===id);if(idx<0)return;
  const name=document.getElementById('nc-name')?.value?.trim();
  const email=document.getElementById('nc-email')?.value?.trim();
  const pass=document.getElementById('nc-pass')?.value;
  if(!name||!email){showToast('‚ö†Ô∏è Preencha nome e e-mail');return;}
  const nicho=document.getElementById('nc-nicho')?.value||clients[idx].nicho;
  const plan=document.getElementById('nc-plan')?.value||clients[idx].plan;
  const status=document.getElementById('nc-status')?.value||clients[idx].status;
  clients[idx]={...clients[idx],name,email,nicho,avatar:nichoAvatars[nicho],nichoLabel:nichoLabels[nicho],plan,planLabel:planLabels[plan],planPrice:planPrices[plan],status,pass:pass&&pass.length>=6?pass:clients[idx].pass};
  saveClients(clients);closeModal();renderClients();updateAgencyStats();showToast(`‚úÖ "${name}" atualizado!`);
}
function confirmDelete(id,name){
  document.getElementById('confirm-msg').textContent=`Remover "${name}" permanentemente?`;
  document.getElementById('confirm-ok').onclick=()=>{clients=clients.filter(c=>c.id!==id);saveClients(clients);closeConfirm();renderClients();updateAgencyStats();showToast(`üóëÔ∏è "${name}" removido.`);};
  document.getElementById('confirmModal').classList.add('open');
}
function closeModal(){document.getElementById('mainModal').classList.remove('open');}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('open');}
document.getElementById('mainModal').addEventListener('click',e=>{if(e.target===document.getElementById('mainModal'))closeModal();});
document.getElementById('confirmModal').addEventListener('click',e=>{if(e.target===document.getElementById('confirmModal'))closeConfirm();});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const titles={dash:'Dashboard',inbox:'üí¨ Conversas',leads:'üë• Leads',funil:'üîª Funil',treinamento:'üß† Treinamento',zapi:'üì± Zapi & Workflow',config:'‚öôÔ∏è Configura√ß√µes'};
function showView(id,btn){
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  const el=document.getElementById('view-'+id);if(el)el.classList.add('active');
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('active'));
  if(btn)btn.classList.add('active');
  const pt=document.getElementById('pageTitle');if(pt)pt.textContent=titles[id]||id;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INBOX / CONVERSAS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderContactList(filter){
  const list=document.getElementById('contactList');if(!list)return;
  const f=filter||'';
  const filtered=f?contactsData.filter(c=>c.name.toLowerCase().includes(f.toLowerCase())||c.phone?.includes(f)):contactsData;
  if(!filtered.length){
    const cl=app.currentClient;
    const zapi=JSON.parse(localStorage.getItem('pulsar_zapi_'+(cl?.id||0))||'{}');
    const hasConfig=zapi.instance&&zapi.token&&zapi.clientToken;
    list.innerHTML='<div style="padding:24px 16px;text-align:center;color:var(--muted);font-size:12px;line-height:1.8;"><div style="font-size:32px;margin-bottom:10px;">üì≠</div>'
      +(f?'Nenhum resultado para "'+f+'"':hasConfig?'<strong style="color:var(--muted2);">Nenhuma conversa ainda</strong><br><br>Clique em <strong style="color:var(--orange);">üì≤ Sincronizar WhatsApp</strong><br>para carregar conversas reais':'<strong style="color:var(--muted2);">Inbox vazio</strong><br><br>Configure as credenciais na aba <em style="color:var(--orange);">Zapi & Workflow</em> e sincronize')+'</div>';
    return;
  }
  list.innerHTML=filtered.map(c=>{
    const tc={hot:'cs-hot',warm:'cs-warm',cold:'cs-cold'};
    const tl={hot:'üî• Quente',warm:'üå°Ô∏è Morno',cold:'‚ùÑÔ∏è Frio'};
    const isActive=currentContact&&String(currentContact.id)===String(c.id);
    return`<div class="contact-item${c.unread?' unread':''}${isActive?' active':''}" onclick="openContact('${c.id}')">
      <div class="ci-ava">${c.avatar}</div>
      <div class="ci-body">
        <div class="ci-top"><div class="ci-name">${c.name}</div><div class="ci-time">${c.time}</div></div>
        <div class="ci-preview">${c.lastMsg}</div>
        <div style="display:flex;align-items:center;gap:6px;margin-top:4px;">
          <span class="ci-score ${tc[c.temp]||'cs-cold'}">${tl[c.temp]||'‚ùÑÔ∏è Frio'} ¬∑ ${c.score}%</span>
          ${c.unread?`<span class="ci-badge">${c.unread}</span>`:''}
          ${c.fromZapi?'<span style="font-size:9px;color:var(--blue);">üì± WA</span>':''}
        </div>
      </div>
    </div>`;
  }).join('');
}
function filterContacts(val){renderContactList(val);}

async function openContact(id){
  const c=contactsData.find(x=>String(x.id)===String(id));if(!c)return;
  currentContact=c;c.unread=0;

  // Abre o painel imediatamente com o que temos
  document.getElementById('chat-placeholder').style.display='none';
  const ac=document.getElementById('active-chat');ac.style.display='flex';
  document.getElementById('ch-ava').textContent=c.avatar;
  document.getElementById('ch-name').textContent=c.name;
  document.getElementById('ch-sub').textContent=(c.phone?'+'+c.phone:'‚Äî')+(c.fromZapi?' ¬∑ üì± WhatsApp Real':' ¬∑ üîµ Simulado');
  const ls=document.getElementById('leadSide');ls.style.display='flex';ls.style.flexDirection='column';
  document.getElementById('ls-ava').textContent=c.avatar;
  document.getElementById('ls-name').textContent=c.name;

  const win=document.getElementById('chatWin');win.innerHTML='';

  // Lazy load do hist√≥rico se ainda n√£o carregou
  if(c.fromZapi&&!c.historyLoaded&&c.phone){
    const loadMsg=document.createElement('div');
    loadMsg.className='sys-bub';loadMsg.id='history-loading';
    loadMsg.textContent='‚è≥ Carregando hist√≥rico do WhatsApp...';
    win.appendChild(loadMsg);
    win.scrollTop=win.scrollHeight;

    const msgs=await fetchZapiHistory(c.phone);
    c.history=msgs;
    c.historyLoaded=true;
    const cl=app.currentClient;
    if(cl)saveClientContacts(cl.id,contactsData);

    // Remove loading indicator
    document.getElementById('history-loading')?.remove();
  }

  chatHistory=[...c.history];
  chatScore=c.score;chatStage=c.stage;chatMsgCount=c.history.filter(m=>m.role==='user').length;
  updateLeadSideUI(chatScore,chatStage);

  win.innerHTML='';
  if(!chatHistory.length){
    const s=document.createElement('div');s.className='sys-bub';
    s.textContent=c.fromZapi?'Nenhuma mensagem carregada ‚Äî verifique o workflow pulsar-messages':'In√≠cio da conversa';
    win.appendChild(s);
  }
  chatHistory.forEach(m=>renderBubble(m.role==='assistant'?'ai':'lead',m.content,false));
  win.scrollTop=win.scrollHeight;
  renderContactList(document.getElementById('search-contacts')?.value||'');
  updateInboxBadges();
}
function closeChat(){
  currentContact=null;
  document.getElementById('chat-placeholder').style.display='flex';
  document.getElementById('active-chat').style.display='none';
  document.getElementById('leadSide').style.display='none';
  renderContactList();
}
async function loadConversations(){
  renderContactList();
  await fetchZapiChats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TABLES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHotTable(){
  const tbody=document.getElementById('hotTbl');if(!tbody)return;
  const hot=contactsData.filter(l=>l.temp==='hot');
  if(!hot.length){tbody.innerHTML='<tr><td colspan="4" style="padding:20px;text-align:center;color:var(--muted);font-size:12px;">Nenhum lead quente ainda ‚Äî o agente est√° qualificando</td></tr>';return;}
  tbody.innerHTML=hot.map(l=>`<tr><td><div class="tname">${l.name}</div><div class="tsub">${l.lastMsg||'‚Äî'}</div></td><td><span class="temp t-hot">üî• Quente</span></td><td><span class="pmini"><span class="pfill" style="width:${l.score}%"></span></span> <span style="font-size:10px;color:var(--orange);">${l.score}%</span></td><td><button class="btn btn-green btn-xs" onclick="sendToWA('${l.name}')">üì± WA</button></td></tr>`).join('');
}
function renderAllTable(){
  const tbody=document.getElementById('allTbl');if(!tbody)return;
  const tc={hot:'t-hot',warm:'t-warm',cold:'t-cold'};
  const tl={hot:'üî• Quente',warm:'üå°Ô∏è Morno',cold:'‚ùÑÔ∏è Frio'};
  if(!contactsData.length){tbody.innerHTML='<tr><td colspan="6" style="padding:20px;text-align:center;color:var(--muted);font-size:12px;">Nenhum lead ainda ‚Äî sincronize o WhatsApp</td></tr>';return;}
  const stNames=['Consci√™ncia','Interesse','Considera√ß√£o','Decis√£o','üî• Quente'];
  tbody.innerHTML=contactsData.map(l=>`<tr><td><div class="tname">${l.name}</div><div class="tsub">${l.lastMsg||'‚Äî'}</div></td><td><span class="temp ${tc[l.temp]||'t-cold'}">${tl[l.temp]||'‚ùÑÔ∏è Frio'}</span></td><td><span class="pmini"><span class="pfill" style="width:${l.score}%"></span></span> <span style="font-size:10px;color:var(--orange);">${l.score}%</span></td><td><span class="sbadge s2">${stNames[l.stage+1]||'Consci√™ncia'}</span></td><td style="font-size:10px;color:var(--muted);">${l.time}</td><td>${l.temp==='hot'?`<button class="btn btn-green btn-xs" onclick="sendToWA('${l.name}')">üì± WA</button>`:`<button class="btn btn-ghost btn-xs" onclick="showView('inbox',null);openContact('${l.id}')">Ver</button>`}</td></tr>`).join('');
}
function exportHot(){showToast('üì± Leads quentes enviados ao WhatsApp!');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TREINAMENTO
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveTraining(){
  const negocio=document.getElementById('t-negocio')?.value||'';
  const persona=document.getElementById('t-persona')?.value||'';
  const servicos=document.getElementById('t-servicos')?.value||'';
  const objecoes=document.getElementById('t-objecoes')?.value||'';
  const perguntas=document.getElementById('t-perguntas')?.value||'';
  const cta=document.getElementById('t-cta')?.value||'';
  const tom=document.getElementById('t-tom')?.value||'';
  const promo=document.getElementById('t-promo')?.value||'';
  const prompt=`Voce e ${persona} trabalhando para ${negocio}. Voce e um SDR especialista no segmento.

SERVICOS: ${servicos}
OBJETIVO: Qualificar leads e conduzi-los ate o CTA: "${cta}". Voce NAO fecha a venda - entrega leads quentes ao vendedor humano.
TOM: ${tom}. Mensagens curtas como WhatsApp. Max 2-3 paragrafos. Emojis moderados.
OBJECOES: ${objecoes}
PERGUNTAS DE QUALIFICACAO: ${perguntas}
${promo?`PROMOCAO ATUAL: ${promo}`:''}

CONTEXTO IMPORTANTE: voce ja pode estar no meio de uma conversa - leia todo o historico antes de responder e NUNCA repita perguntas ja feitas. Continue a conversa de onde parou.
FUNIL: Consciencia‚ÜíInteresse‚ÜíConsideracao‚ÜíDecisao‚ÜíLead Quente
Quando o lead demonstrar alta intencao (disponibilidade + interesse real), inclua exatamente: [LEAD_QUENTE]
Nunca invente precos. Nao repita saudacoes se conversa ja comecou. Pergunte UMA coisa por vez.
Responda SEMPRE em portugues brasileiro.`;
  document.getElementById('prompt-output').style.display='block';
  document.getElementById('prompt-text').value=prompt;
  // Salva training do cliente
  if(app.currentClient){
    const td={negocio,persona,servicos,objecoes,perguntas,cta,tom:document.getElementById('t-tom')?.value||''};
    localStorage.setItem('pulsar_training_'+app.currentClient.id,JSON.stringify(td));
  }
  showToast('‚úÖ Configura√ß√µes salvas! Copie o prompt para o n8n.');
}
function copyPrompt(){
  const t=document.getElementById('prompt-text');
  if(t){navigator.clipboard.writeText(t.value).then(()=>showToast('üìã Prompt copiado! Cole no n√≥ Code do n8n.'));}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ZAPI CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveZapiConfig(){
  const c=app.currentClient;if(!c){showToast('‚ö†Ô∏è Fa√ßa login como cliente');return;}
  const config={
    instance:document.getElementById('zapi-instance')?.value||'',
    token:document.getElementById('zapi-token')?.value||'',
    clientToken:document.getElementById('zapi-client-token')?.value||'',
    webhookUrl:document.getElementById('n8n-webhook-url')?.value||'',
    n8nBase:document.getElementById('n8n-base-url')?.value||'',
    n8nAuthToken:document.getElementById('n8n-auth-token')?.value||'',
    active:app.agentActive,
  };
  localStorage.setItem('pulsar_zapi_'+c.id,JSON.stringify(config));
  showToast('‚úÖ Configura√ß√µes Zapi salvas! Verificando conex√£o...');
  setTimeout(()=>checkZapiStatus(),500);
}
function openN8nWorkflow(){const url=document.getElementById('n8n-base-url')?.value||'https://app.n8n.cloud';window.open(url,'_blank');}
function openZapi(){window.open('https://app.z-api.io','_blank');}
function openClaude(){window.open('https://console.anthropic.com','_blank');}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API KEY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function saveAgencyApiKey(){
  const key=document.getElementById('agencyApiKey')?.value?.trim();
  const model=document.getElementById('agencyModel')?.value;
  if(!key||!key.startsWith('sk-')){showToast('‚ö†Ô∏è Chave inv√°lida ‚Äî deve come√ßar com sk-');return;}
  localStorage.setItem('pulsar_agency_apikey',key);
  if(model)localStorage.setItem('pulsar_agency_model',model);
  app.apiKey=key;app.model=model||app.model;
  updateApiStatusBadge(key);showToast('‚úÖ API Key salva!');
}
function checkApiKey(val){updateApiStatusBadge(val);}
function updateApiStatusBadge(key){
  const b=document.getElementById('apiStatusBadge');if(!b)return;
  if(key&&key.startsWith('sk-')&&key.length>20){b.textContent='‚úÖ Ativa';b.style.cssText='font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(0,230,118,.12);color:var(--green);border:1px solid rgba(0,230,118,.2);';}
  else{b.textContent='N√£o configurada';b.style.cssText='font-size:10px;font-weight:700;padding:3px 9px;border-radius:20px;background:rgba(255,71,87,.12);color:var(--red);border:1px solid rgba(255,71,87,.2);';}
}
function toggleApiKeyVisibility(){const inp=document.getElementById('agencyApiKey');if(!inp)return;inp.type=inp.type==='password'?'text':'password';}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// WA / MISC
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INBOX CHAT FUNCTIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderBubble(role,text,scroll){
  const clean=(text||'').replace('[LEAD_QUENTE]','').trim();
  const win=document.getElementById('chatWin');if(!win)return;
  const row=document.createElement('div');
  row.className='bubble-row '+(role==='lead'?'lr':'');
  const now=new Date();const t=now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
  row.innerHTML=`<div class="av ${role==='ai'?'ai':'lead'}">${role==='ai'?'SDR':currentContact?.avatar||'üë§'}</div>
    <div class="bdy">
      <div class="bsender">${role==='ai'?'Agente SDR ‚Äî IA':'Lead'}</div>
      <div class="bubble ${role==='ai'?'ai-bub':'lead-bub'}">${clean}</div>
      <div class="btime">${t}</div>
    </div>`;
  win.appendChild(row);if(scroll)win.scrollTop=win.scrollHeight;
}
function showTypingInbox(){
  const win=document.getElementById('chatWin');if(!win)return;
  const r=document.createElement('div');r.className='typing-row';r.id='tr_inbox';
  r.innerHTML=`<div class="av ai">SDR</div><div class="tbub"><div class="td"></div><div class="td"></div><div class="td"></div></div>`;
  win.appendChild(r);win.scrollTop=win.scrollHeight;
}
function hideTypingInbox(){document.getElementById('tr_inbox')?.remove();}

async function sendInboxMsg(){
  const inp=document.getElementById('chatIn');
  const btn=document.getElementById('sendBtn');
  if(!inp||!currentContact||btn?.disabled)return;
  const text=inp.value.trim();if(!text)return;
  inp.value='';inp.style.height='auto';
  if(btn)btn.disabled=true;
  chatHistory.push({role:'user',content:text});
  renderBubble('lead',text,true);
  currentContact.lastMsg=text;currentContact.time='Agora';
  // Se √© contato real do WhatsApp, mostra aviso ‚Äî a resposta vem pelo agente n8n
  if(currentContact.fromZapi){
    showToast('üì§ Mensagem enviada ‚Äî aguarde a resposta do agente IA');
    // Atualiza hist√≥rico em alguns segundos
    setTimeout(()=>refreshContactMessages(currentContact.phone),5000);
    setTimeout(()=>refreshContactMessages(currentContact.phone),12000);
    if(btn)btn.disabled=false;inp.focus();
    return;
  }
  showTypingInbox();
  const reply=await callAI_inbox(text,currentContact.nicho);
  hideTypingInbox();
  const isHot=reply.includes('[LEAD_QUENTE]');
  chatMsgCount++;
  chatStage=isHot?4:Math.min(Math.floor(chatMsgCount/1.2),3);
  chatScore=isHot?92:Math.min((chatScore||0)+(Math.random()*8+4),98);
  chatHistory.push({role:'assistant',content:reply});
  currentContact.history=[...chatHistory];
  currentContact.score=Math.round(chatScore);
  if(isHot)currentContact.temp='hot';
  if(app.currentClient)saveClientContacts(app.currentClient.id,contactsData);
  renderBubble('ai',reply,true);
  updateLeadSideUI(chatScore,chatStage);
  if(isHot){
    setTimeout(()=>{showToast('üî• Lead Quente! Notificando vendedor...');const b=document.getElementById('ls-wa-btn');if(b)b.disabled=false;},400);
  }
  renderContactList(document.getElementById('search-contacts')?.value||'');
  renderHotTable();renderAllTable();
  updateInboxBadges();
  if(btn)btn.disabled=false;inp.focus();
}
function hkInbox(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendInboxMsg();}}

async function callAI_inbox(msg,nicho){
  const key=app.apiKey;
  // Usa prompt gerado em Treinamento se dispon√≠vel
  let system='';
  const promptEl=document.getElementById('prompt-text');
  if(promptEl&&promptEl.value&&promptEl.value.length>30){
    system=promptEl.value;
  }else{
    const nd=nichoData[nicho]||nichoData.clinica;
    system=`Voc√™ √© ${nd.persona} trabalhando para ${nd.negocio}. SDR especialista em ${nd.name}.
SERVI√áOS: ${nd.servicos}
OBJETIVO: Qualificar leads at√© o CTA: "${nd.cta}". TOM: ${nd.tom}. Mensagens curtas, m√°x 2-3 par√°grafos. Emojis moderados.
OBJE√á√ïES: ${nd.objecoes}
CONTEXTO: Voc√™ pode estar no meio de uma conversa ‚Äî leia todo o hist√≥rico e NUNCA repita perguntas j√° feitas. Continue de onde parou.
FUNIL: Consci√™ncia‚ÜíInteresse‚ÜíConsidera√ß√£o‚ÜíDecis√£o‚ÜíLead Quente
Quando lead demonstrar alta inten√ß√£o, inclua: [LEAD_QUENTE]
Nunca invente pre√ßos. Responda SEMPRE em portugu√™s.`;
  }
  if(!key){return getFallbackMsg(nicho,chatMsgCount);}
  try{
    const messages=chatHistory.slice(-12).map(m=>({role:m.role,content:m.content}));
    const res=await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01'},
      body:JSON.stringify({model:app.model,max_tokens:600,system,messages})
    });
    const data=await res.json();
    if(data.error){console.error('Claude error:',data.error);return getFallbackMsg(nicho,chatMsgCount);}
    return data.content?.[0]?.text||'Desculpe, tente novamente.';
  }catch(e){console.error('Fetch error:',e);return getFallbackMsg(nicho,chatMsgCount);}
}

function getFallbackMsg(nicho,count){
  const msgs={
    clinica:['Ol√°! üòä Sou a consultora da cl√≠nica. O que te trouxe at√© n√≥s hoje?','Entendo! Voc√™ j√° fez algum procedimento est√©tico antes?','√ìtimo! Que tal uma avalia√ß√£o gratuita para conhecer o protocolo ideal para voc√™?','Perfeito! Voc√™ prefere manh√£ ou tarde?','Maravilha! Vou verificar os hor√°rios dispon√≠veis üòä'],
    restaurante:['Ol√°! üòä Como posso ajudar?','√ìtimo! Qual seria a ocasi√£o?','Quantas pessoas seriam?','Que data voc√™ tem em mente?','Maravilha! Vou verificar a disponibilidade.'],
    geral:['Ol√°! üòä Como posso ajudar voc√™ hoje?','√ìtimo! Pode me contar mais sobre o que voc√™ est√° buscando?','Entendo! Vamos encontrar a melhor solu√ß√£o para voc√™.','Que tal agendarmos uma conversa para detalhar melhor?','Perfeito! Vou verificar as op√ß√µes dispon√≠veis.'],
  };
  const list=msgs[nicho]||msgs.geral;
  return list[Math.min(count,list.length-1)];
}

function updateLeadSideUI(score,stage){
  const pct=Math.round(score)+'%';
  const stNames=['Consci√™ncia','Interesse','Considera√ß√£o','Decis√£o','üî• Quente'];
  const tempLbls=['‚ùÑÔ∏è Frio','‚ùÑÔ∏è Frio','üå°Ô∏è Morno','üå°Ô∏è Morno','üî• Quente'];
  const intLbls=['‚ùÑÔ∏è Baixa','‚ùÑÔ∏è Baixa','üå°Ô∏è M√©dia','üî• Alta','üî• Muito Alta'];
  const el=id=>document.getElementById(id);
  if(el('ls-score'))el('ls-score').textContent=pct;
  if(el('ls-score-fill'))el('ls-score-fill').style.width=pct;
  if(el('ls-sub'))el('ls-sub').textContent=stage>=0?(stNames[stage]||'‚Äî')+' ‚Äî Em qualifica√ß√£o':'Aguardando qualifica√ß√£o';
  if(el('ls-temp')&&stage>=0)el('ls-temp').textContent=tempLbls[stage];
  if(el('ls-intent')&&stage>=0)el('ls-intent').textContent=intLbls[stage];
  const lt=el('ls-tags');if(lt){
    let tags=[];
    if(score>=70)tags.push('<span class="tag" style="color:var(--orange);border-color:rgba(255,101,53,.3);">üî• Alta inten√ß√£o</span>');
    if(stage>=3)tags.push('<span class="tag" style="color:var(--green);border-color:rgba(0,230,118,.3);">üìÖ Dispon√≠vel</span>');
    if(chatMsgCount>=2)tags.push('<span class="tag">üí¨ Engajado</span>');
    lt.innerHTML=tags.join('')||'<span class="tag">üí¨ Em contato</span>';
  }
  const jtrack=el('ls-jtrack');if(jtrack){
    const icons=['üîç','üí°','‚öñÔ∏è','üéØ','ü§ù'];
    jtrack.querySelectorAll('.jstep').forEach((s,i)=>{
      const d=s.querySelector('.jdot');if(!d)return;d.className='jdot';
      if(i<stage){d.classList.add('done');d.textContent='‚úì';}
      else if(i===stage){d.classList.add('now');d.textContent=icons[i];}
      else{d.classList.add('todo');d.textContent=icons[i];}
    });
  }
  if(stage>=4&&el('ls-wa-btn'))el('ls-wa-btn').disabled=false;
}

function newConvoModal(){
  const name=prompt('Nome do lead (simulado):','Lead Teste');
  if(!name)return;
  const newContact={
    id:String(Date.now()),name,
    phone:'5511'+Math.floor(Math.random()*900000000+100000000),
    avatar:getAvatar(name),lastMsg:'Nova conversa simulada',
    time:'Agora',unread:0,score:0,stage:-1,temp:'cold',
    nicho:app.currentClient?.nicho||'geral',history:[],
    fromZapi:false
  };
  contactsData.unshift(newContact);
  if(app.currentClient)saveClientContacts(app.currentClient.id,contactsData);
  renderContactList();
  updateInboxBadges();
  setTimeout(()=>openContact(newContact.id),100);
}


function sendToWA(name){
  const wa=app.waNumber||localStorage.getItem('p_wa')||'5511999999999';
  const msg=encodeURIComponent(`üî• Lead Quente: ${name}\nQualificado pelo Agente SDR Pulsar!\nScore: ${Math.round(chatScore||88)}%\nPronto para fechamento üí™`);
  window.open(`https://wa.me/${wa}?text=${msg}`,'_blank');
}
function copyField(id){const el=document.getElementById(id);if(el)navigator.clipboard.writeText(el.value||'').then(()=>showToast('üìã Copiado!'));}
function saveClientWA(){const wa=document.getElementById('waInp')?.value?.trim();if(wa){app.waNumber=wa;localStorage.setItem('p_wa',wa);}showToast('‚úÖ N√∫mero salvo!');}
function openSupportWA(){window.open('https://wa.me/5511999999999?text='+encodeURIComponent('Preciso de suporte com o Pulsar SDR.'),'_blank');}
function showToast(msg){document.getElementById('tMsg').textContent=msg;const t=document.getElementById('toast');t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3500);}
document.querySelectorAll('.chat-in').forEach(inp=>{inp.addEventListener('input',function(){this.style.height='auto';this.style.height=Math.min(this.scrollHeight,100)+'px';});});

// INIT
window.addEventListener('load',()=>{
  const k=localStorage.getItem('pulsar_agency_apikey');if(k)app.apiKey=k;
  const m=localStorage.getItem('pulsar_agency_model');if(m)app.model=m;
  const wa=localStorage.getItem('p_wa');if(wa)app.waNumber=wa;
  // Set dashboard last response time
  const lr=document.getElementById('dash-last-resp');if(lr)lr.textContent=new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
  const dac=document.getElementById('dash-active-conv');if(dac)dac.textContent=contactsData.filter(c=>c.unread>0).length;
});
</script>
</body>
</html>
